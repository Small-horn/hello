<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的收藏 - 简化版</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .test-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 1rem 0;
            padding: 1rem;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .result {
            margin: 0.5rem 0;
            padding: 0.5rem;
            background: #f5f5f5;
            border-radius: 4px;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1><i class="fas fa-star"></i> 我的收藏 - 简化测试版</h1>
        
        <div class="test-section">
            <h3>1. 页面加载状态</h3>
            <div id="load-status" class="result info">页面正在加载...</div>
        </div>
        
        <div class="test-section">
            <h3>2. 用户认证状态</h3>
            <div id="auth-status" class="result">检查中...</div>
            <button onclick="checkAuth()">重新检查认证</button>
        </div>
        
        <div class="test-section">
            <h3>3. API测试</h3>
            <div id="api-status" class="result">未测试</div>
            <button onclick="testAPI()">测试收藏API</button>
        </div>
        
        <div class="test-section">
            <h3>4. 收藏数据</h3>
            <div id="favorites-data" class="result">未加载</div>
            <button onclick="loadFavorites()">加载收藏数据</button>
        </div>
        
        <div class="test-section">
            <h3>5. 导航测试</h3>
            <a href="dashboard.html" class="btn">返回首页</a>
            <a href="announcements.html" class="btn">公告页面</a>
            <a href="favorites.html" class="btn">完整收藏页面</a>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        let currentUser = null;
        
        $(document).ready(function() {
            $('#load-status').html('<span class="success">页面加载完成</span>');
            console.log('简化收藏页面加载完成');
            
            // 自动检查认证状态
            setTimeout(checkAuth, 500);
        });
        
        function checkAuth() {
            $('#auth-status').html('检查中...');
            
            // 方法1: 检查sessionStorage
            const storedUser = sessionStorage.getItem('currentUser');
            if (storedUser) {
                try {
                    currentUser = JSON.parse(storedUser);
                    $('#auth-status').html(`<span class="success">用户已登录 (sessionStorage): ${currentUser.username}</span>`);
                    return;
                } catch (e) {
                    console.error('解析用户信息失败:', e);
                }
            }
            
            // 方法2: 通过API检查
            $.ajax({
                url: '/api/auth/current',
                method: 'GET',
                success: function(response) {
                    console.log('API认证检查结果:', response);
                    if (response.success && response.authenticated && response.user) {
                        currentUser = response.user;
                        sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
                        $('#auth-status').html(`<span class="success">用户已登录 (API): ${currentUser.username}</span>`);
                    } else {
                        $('#auth-status').html('<span class="error">用户未登录</span>');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('认证检查失败:', error);
                    $('#auth-status').html(`<span class="error">认证检查失败: ${error}</span>`);
                }
            });
        }
        
        function testAPI() {
            if (!currentUser) {
                $('#api-status').html('<span class="error">请先登录</span>');
                return;
            }
            
            $('#api-status').html('测试中...');
            
            // 测试收藏统计API
            $.ajax({
                url: `/api/favorites/user/${currentUser.id}/stats`,
                method: 'GET',
                success: function(response) {
                    $('#api-status').html(`<span class="success">API测试成功: 总收藏${response.total}个</span>`);
                },
                error: function(xhr, status, error) {
                    $('#api-status').html(`<span class="error">API测试失败: ${error}</span>`);
                }
            });
        }
        
        function loadFavorites() {
            if (!currentUser) {
                $('#favorites-data').html('<span class="error">请先登录</span>');
                return;
            }
            
            $('#favorites-data').html('加载中...');
            
            // 加载收藏列表
            $.ajax({
                url: `/api/favorites/user/${currentUser.id}/announcements/details`,
                method: 'GET',
                data: { page: 0, size: 5 },
                success: function(response) {
                    console.log('收藏数据:', response);
                    const count = response.content ? response.content.length : 0;
                    $('#favorites-data').html(`<span class="success">加载成功: 找到${count}条收藏记录</span>`);
                    
                    if (count > 0) {
                        let html = '<ul>';
                        response.content.forEach(item => {
                            if (item.announcement) {
                                html += `<li>${item.announcement.title}</li>`;
                            }
                        });
                        html += '</ul>';
                        $('#favorites-data').append(html);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('加载收藏失败:', error);
                    $('#favorites-data').html(`<span class="error">加载失败: ${error}</span>`);
                }
            });
        }
    </script>
</body>
</html>
