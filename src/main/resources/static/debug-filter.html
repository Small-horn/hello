<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>筛选功能调试页面</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/management.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .debug-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 2rem;
        }
        
        .debug-section {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
            overflow: hidden;
        }
        
        .debug-header {
            background: #f8f9fa;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #dee2e6;
            font-weight: 600;
        }
        
        .debug-content {
            padding: 1.5rem;
        }
        
        .test-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        
        .debug-output {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 1rem;
            margin-top: 1rem;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }
        
        .status-success { background: #28a745; }
        .status-error { background: #dc3545; }
        .status-warning { background: #ffc107; }
        .status-info { background: #17a2b8; }
        
        .api-test-result {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 4px;
            border-left: 4px solid #007bff;
            background: #f8f9fa;
        }
        
        .error-result {
            border-left-color: #dc3545;
            background: #f8d7da;
        }
        
        .success-result {
            border-left-color: #28a745;
            background: #d4edda;
        }
    </style>
</head>
<body>
    <div class="debug-container">
        <h1>🔧 筛选功能调试页面</h1>
        <p>用于调试和测试公告管理页面的筛选功能问题</p>
        
        <!-- API 连接测试 -->
        <div class="debug-section">
            <div class="debug-header">
                <i class="fas fa-plug"></i> API 连接测试
            </div>
            <div class="debug-content">
                <div class="test-controls">
                    <button onclick="testBasicAPI()" class="btn btn-primary">
                        <i class="fas fa-play"></i> 测试基础API
                    </button>
                    <button onclick="testFilterAPI()" class="btn btn-info">
                        <i class="fas fa-filter"></i> 测试筛选API
                    </button>
                    <button onclick="testSearchAPI()" class="btn btn-success">
                        <i class="fas fa-search"></i> 测试搜索API
                    </button>
                    <button onclick="clearDebugOutput()" class="btn btn-secondary">
                        <i class="fas fa-eraser"></i> 清除输出
                    </button>
                </div>
                
                <div id="api-test-output" class="debug-output">等待测试...</div>
            </div>
        </div>
        
        <!-- 参数验证测试 -->
        <div class="debug-section">
            <div class="debug-header">
                <i class="fas fa-check-circle"></i> 参数验证测试
            </div>
            <div class="debug-content">
                <div class="test-controls">
                    <select id="test-status" class="form-control">
                        <option value="">选择状态</option>
                        <option value="DRAFT">DRAFT</option>
                        <option value="PUBLISHED">PUBLISHED</option>
                        <option value="CANCELLED">CANCELLED</option>
                        <option value="EXPIRED">EXPIRED</option>
                        <option value="INVALID">INVALID (无效值)</option>
                    </select>
                    
                    <select id="test-type" class="form-control">
                        <option value="">选择类型</option>
                        <option value="ANNOUNCEMENT">ANNOUNCEMENT</option>
                        <option value="ACTIVITY">ACTIVITY</option>
                        <option value="INVALID">INVALID (无效值)</option>
                    </select>
                    
                    <input type="text" id="test-keyword" placeholder="搜索关键词" class="form-control">
                    
                    <button onclick="testParameters()" class="btn btn-warning">
                        <i class="fas fa-vial"></i> 测试参数
                    </button>
                </div>
                
                <div id="param-test-output" class="debug-output">等待测试...</div>
            </div>
        </div>
        
        <!-- 错误模拟 -->
        <div class="debug-section">
            <div class="debug-header">
                <i class="fas fa-bug"></i> 错误模拟
            </div>
            <div class="debug-content">
                <div class="test-controls">
                    <button onclick="simulate500Error()" class="btn btn-danger">
                        <i class="fas fa-exclamation-triangle"></i> 模拟500错误
                    </button>
                    <button onclick="simulate404Error()" class="btn btn-warning">
                        <i class="fas fa-question-circle"></i> 模拟404错误
                    </button>
                    <button onclick="simulateNetworkError()" class="btn btn-dark">
                        <i class="fas fa-wifi"></i> 模拟网络错误
                    </button>
                </div>
                
                <div id="error-test-output" class="debug-output">等待测试...</div>
            </div>
        </div>
        
        <!-- 实时日志 -->
        <div class="debug-section">
            <div class="debug-header">
                <i class="fas fa-list"></i> 实时日志
            </div>
            <div class="debug-content">
                <div class="test-controls">
                    <button onclick="startLogging()" class="btn btn-success">
                        <i class="fas fa-play"></i> 开始记录
                    </button>
                    <button onclick="stopLogging()" class="btn btn-danger">
                        <i class="fas fa-stop"></i> 停止记录
                    </button>
                    <button onclick="clearLogs()" class="btn btn-secondary">
                        <i class="fas fa-trash"></i> 清除日志
                    </button>
                </div>
                
                <div id="real-time-logs" class="debug-output">日志记录已停止</div>
            </div>
        </div>
        
        <!-- 解决方案建议 -->
        <div class="debug-section">
            <div class="debug-header">
                <i class="fas fa-lightbulb"></i> 解决方案建议
            </div>
            <div class="debug-content">
                <h5>常见问题及解决方案：</h5>
                <ul>
                    <li><strong>500错误</strong>: 
                        <ul>
                            <li>检查后端Service层的枚举转换逻辑</li>
                            <li>确认数据库中的枚举值格式</li>
                            <li>验证Repository中的查询语句</li>
                        </ul>
                    </li>
                    <li><strong>筛选无结果</strong>:
                        <ul>
                            <li>检查前端传递的参数格式</li>
                            <li>确认后端接收参数的大小写</li>
                            <li>验证数据库中是否有对应状态的数据</li>
                        </ul>
                    </li>
                    <li><strong>搜索功能异常</strong>:
                        <ul>
                            <li>检查搜索接口是否正常</li>
                            <li>确认前端筛选逻辑是否正确</li>
                            <li>验证关键词编码问题</li>
                        </ul>
                    </li>
                </ul>
                
                <h5>调试步骤：</h5>
                <ol>
                    <li>首先测试基础API是否正常</li>
                    <li>然后测试单个筛选条件</li>
                    <li>最后测试组合筛选条件</li>
                    <li>查看浏览器控制台的详细错误信息</li>
                    <li>检查网络请求的参数和响应</li>
                </ol>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        let isLogging = false;
        let originalConsoleLog = console.log;
        let originalConsoleError = console.error;
        
        // 重写console方法来捕获日志
        function startLogging() {
            isLogging = true;
            $('#real-time-logs').text('开始记录日志...\n');
            
            console.log = function(...args) {
                originalConsoleLog.apply(console, args);
                if (isLogging) {
                    appendLog('LOG', args.join(' '));
                }
            };
            
            console.error = function(...args) {
                originalConsoleError.apply(console, args);
                if (isLogging) {
                    appendLog('ERROR', args.join(' '));
                }
            };
        }
        
        function stopLogging() {
            isLogging = false;
            console.log = originalConsoleLog;
            console.error = originalConsoleError;
            appendLog('INFO', '日志记录已停止');
        }
        
        function clearLogs() {
            $('#real-time-logs').text('日志已清除\n');
        }
        
        function appendLog(level, message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${level}: ${message}\n`;
            $('#real-time-logs').append(logEntry);
            $('#real-time-logs').scrollTop($('#real-time-logs')[0].scrollHeight);
        }
        
        function testBasicAPI() {
            appendOutput('api-test-output', '测试基础API...');
            
            $.ajax({
                url: '/api/announcements',
                method: 'GET',
                data: { page: 0, size: 10 },
                success: function(data) {
                    const result = `✅ 基础API测试成功
请求URL: /api/announcements
参数: page=0, size=10
返回数据: ${JSON.stringify(data, null, 2)}`;
                    appendOutput('api-test-output', result);
                },
                error: function(xhr, status, error) {
                    const result = `❌ 基础API测试失败
状态码: ${xhr.status}
错误: ${error}
响应: ${xhr.responseText}`;
                    appendOutput('api-test-output', result);
                }
            });
        }
        
        function testFilterAPI() {
            appendOutput('api-test-output', '测试筛选API...');
            
            const testCases = [
                { status: 'PUBLISHED', type: '', desc: '仅状态筛选' },
                { status: '', type: 'ANNOUNCEMENT', desc: '仅类型筛选' },
                { status: 'PUBLISHED', type: 'ANNOUNCEMENT', desc: '组合筛选' }
            ];
            
            testCases.forEach((testCase, index) => {
                setTimeout(() => {
                    $.ajax({
                        url: '/api/announcements',
                        method: 'GET',
                        data: {
                            page: 0,
                            size: 10,
                            status: testCase.status,
                            type: testCase.type
                        },
                        success: function(data) {
                            const result = `✅ ${testCase.desc} - 成功
参数: status=${testCase.status}, type=${testCase.type}
结果数量: ${data.totalElements || 0}`;
                            appendOutput('api-test-output', result);
                        },
                        error: function(xhr, status, error) {
                            const result = `❌ ${testCase.desc} - 失败
参数: status=${testCase.status}, type=${testCase.type}
状态码: ${xhr.status}
错误: ${error}`;
                            appendOutput('api-test-output', result);
                        }
                    });
                }, index * 1000);
            });
        }
        
        function testSearchAPI() {
            appendOutput('api-test-output', '测试搜索API...');
            
            $.ajax({
                url: '/api/announcements/search',
                method: 'GET',
                data: {
                    page: 0,
                    size: 10,
                    keyword: '通知'
                },
                success: function(data) {
                    const result = `✅ 搜索API测试成功
关键词: 通知
结果数量: ${data.totalElements || 0}
返回数据: ${JSON.stringify(data, null, 2)}`;
                    appendOutput('api-test-output', result);
                },
                error: function(xhr, status, error) {
                    const result = `❌ 搜索API测试失败
状态码: ${xhr.status}
错误: ${error}
响应: ${xhr.responseText}`;
                    appendOutput('api-test-output', result);
                }
            });
        }
        
        function testParameters() {
            const status = $('#test-status').val();
            const type = $('#test-type').val();
            const keyword = $('#test-keyword').val();
            
            appendOutput('param-test-output', `测试参数组合:
状态: ${status || '无'}
类型: ${type || '无'}
关键词: ${keyword || '无'}`);
            
            // 参数验证
            const validStatuses = ['DRAFT', 'PUBLISHED', 'CANCELLED', 'EXPIRED'];
            const validTypes = ['ANNOUNCEMENT', 'ACTIVITY'];
            
            let validationResult = '参数验证结果:\n';
            
            if (status) {
                if (validStatuses.includes(status)) {
                    validationResult += `✅ 状态参数有效: ${status}\n`;
                } else {
                    validationResult += `❌ 状态参数无效: ${status}\n`;
                }
            }
            
            if (type) {
                if (validTypes.includes(type)) {
                    validationResult += `✅ 类型参数有效: ${type}\n`;
                } else {
                    validationResult += `❌ 类型参数无效: ${type}\n`;
                }
            }
            
            if (keyword) {
                validationResult += `✅ 关键词: ${keyword}\n`;
            }
            
            appendOutput('param-test-output', validationResult);
            
            // 实际API测试
            let url = '/api/announcements';
            let params = { page: 0, size: 10 };
            
            if (status) params.status = status;
            if (type) params.type = type;
            
            if (keyword) {
                url = '/api/announcements/search';
                params.keyword = keyword;
            }
            
            $.ajax({
                url: url,
                method: 'GET',
                data: params,
                success: function(data) {
                    appendOutput('param-test-output', `✅ API调用成功，返回 ${data.totalElements || 0} 条记录`);
                },
                error: function(xhr, status, error) {
                    appendOutput('param-test-output', `❌ API调用失败: ${xhr.status} - ${error}`);
                }
            });
        }
        
        function simulate500Error() {
            appendOutput('error-test-output', '模拟500错误...');
            
            $.ajax({
                url: '/api/announcements',
                method: 'GET',
                data: { status: 'INVALID_STATUS' },
                success: function(data) {
                    appendOutput('error-test-output', '意外成功 - 应该返回错误');
                },
                error: function(xhr, status, error) {
                    appendOutput('error-test-output', `模拟500错误结果:
状态码: ${xhr.status}
错误类型: ${status}
错误信息: ${error}
响应内容: ${xhr.responseText}`);
                }
            });
        }
        
        function simulate404Error() {
            appendOutput('error-test-output', '模拟404错误...');
            
            $.ajax({
                url: '/api/nonexistent-endpoint',
                method: 'GET',
                success: function(data) {
                    appendOutput('error-test-output', '意外成功 - 应该返回404');
                },
                error: function(xhr, status, error) {
                    appendOutput('error-test-output', `模拟404错误结果:
状态码: ${xhr.status}
错误类型: ${status}
错误信息: ${error}`);
                }
            });
        }
        
        function simulateNetworkError() {
            appendOutput('error-test-output', '模拟网络错误...');
            
            $.ajax({
                url: 'http://invalid-domain-that-does-not-exist.com/api',
                method: 'GET',
                timeout: 3000,
                success: function(data) {
                    appendOutput('error-test-output', '意外成功 - 应该返回网络错误');
                },
                error: function(xhr, status, error) {
                    appendOutput('error-test-output', `模拟网络错误结果:
状态码: ${xhr.status}
错误类型: ${status}
错误信息: ${error}`);
                }
            });
        }
        
        function appendOutput(elementId, text) {
            const timestamp = new Date().toLocaleTimeString();
            const output = $(`#${elementId}`);
            output.append(`\n[${timestamp}] ${text}\n`);
            output.scrollTop(output[0].scrollHeight);
        }
        
        function clearDebugOutput() {
            $('#api-test-output').text('输出已清除');
            $('#param-test-output').text('输出已清除');
            $('#error-test-output').text('输出已清除');
        }
    </script>
</body>
</html>
