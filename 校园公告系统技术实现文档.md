# 校园公告系统技术实现文档

## 目录

1. [技术架构概述](#技术架构概述)
2. [核心技术栈](#核心技术栈)
3. [系统架构设计](#系统架构设计)
4. [数据库设计详解](#数据库设计详解)
5. [后端技术实现](#后端技术实现)
6. [前端技术实现](#前端技术实现)
7. [安全机制设计](#安全机制设计)
8. [性能优化策略](#性能优化策略)
9. [Docker容器化部署](#Docker容器化部署)
10. [API接口文档](#API接口文档)

---

## 技术架构概述

### 整体架构模式

本系统采用经典的三层架构模式，结合现代微服务理念，实现了高内聚、低耦合的系统设计：

```
┌─────────────────────────────────────────────────────────────┐
│                    表现层 (Presentation Layer)                │
├─────────────────────────────────────────────────────────────┤
│  Web Browser  │  HTML5 + CSS3 + JavaScript + jQuery        │
│               │  响应式设计 + AJAX异步通信                    │
└─────────────────────────────────────────────────────────────┘
                              │ HTTP/HTTPS
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    业务层 (Business Layer)                   │
├─────────────────────────────────────────────────────────────┤
│  Spring Boot  │  RESTful API + MVC模式                      │
│  Application  │  业务逻辑处理 + 权限控制                      │
│               │  Session管理 + 数据验证                      │
└─────────────────────────────────────────────────────────────┘
                              │ JDBC
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    数据层 (Data Layer)                       │
├─────────────────────────────────────────────────────────────┤
│  MySQL 8.0    │  关系型数据库 + 事务管理                      │
│  Database     │  数据持久化 + 索引优化                       │
│               │  备份恢复 + 性能监控                         │
└─────────────────────────────────────────────────────────────┘
```

### 技术选型原则

1. **稳定性优先**：选择成熟稳定的技术栈，确保系统可靠性
2. **性能考虑**：采用高性能的框架和数据库，支持高并发访问
3. **开发效率**：使用Spring Boot等快速开发框架，提高开发效率
4. **可维护性**：代码结构清晰，遵循设计模式和编码规范
5. **扩展性**：预留扩展接口，支持功能模块的灵活扩展

---

## 核心技术栈

### 后端技术栈

| 技术组件 | 版本 | 用途说明 |
|---------|------|----------|
| **Java** | 17 LTS | 核心编程语言，提供强类型和面向对象特性 |
| **Spring Boot** | 3.5.0 | 微服务框架，简化Spring应用开发 |
| **Spring Data JPA** | 3.5.0 | 数据访问层框架，简化数据库操作 |
| **Hibernate** | 6.x | ORM框架，对象关系映射 |
| **MySQL** | 8.0 | 关系型数据库，数据持久化存储 |
| **Maven** | 3.8+ | 项目构建和依赖管理工具 |

### 前端技术栈

| 技术组件 | 版本 | 用途说明 |
|---------|------|----------|
| **HTML5** | - | 页面结构标记语言 |
| **CSS3** | - | 样式表语言，响应式设计 |
| **JavaScript** | ES6+ | 客户端脚本语言，交互逻辑 |
| **jQuery** | 3.6.0 | JavaScript库，简化DOM操作 |
| **Font Awesome** | 6.4.0 | 图标字体库，UI图标显示 |
| **Quill.js** | 1.3.7 | 富文本编辑器，内容编辑 |

### 部署技术栈

| 技术组件 | 版本 | 用途说明 |
|---------|------|----------|
| **Docker** | 20.10+ | 容器化平台，应用打包部署 |
| **Docker Compose** | 2.0+ | 多容器编排工具 |
| **Nginx** | Alpine | 反向代理服务器，负载均衡 |
| **OpenJDK** | 17-alpine | Java运行时环境 |

---

## 系统架构设计

### MVC架构模式

系统严格遵循MVC（Model-View-Controller）设计模式：

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│      View       │    │   Controller    │    │      Model      │
│   (前端页面)     │◄──►│   (控制器层)     │◄──►│   (数据模型)     │
├─────────────────┤    ├─────────────────┤    ├─────────────────┤
│ • HTML页面      │    │ • AuthController│    │ • User实体      │
│ • CSS样式       │    │ • UserController│    │ • Announcement  │
│ • JavaScript    │    │ • AnnouncementC │    │ • Comment实体   │
│ • AJAX请求      │    │ • CommentContro │    │ • Like实体      │
│ • 用户交互      │    │ • 请求处理      │    │ • Favorite实体  │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 分层架构设计

```
┌─────────────────────────────────────────────────────────────┐
│                    Controller Layer                         │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │
│  │AuthControll │ │UserControll │ │AnnouncementC│    ...    │
│  │er           │ │er           │ │ontroller    │           │
│  └─────────────┘ └─────────────┘ └─────────────┘           │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                     Service Layer                          │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │
│  │AuthService  │ │UserService  │ │AnnouncementS│    ...    │
│  │             │ │             │ │ervice       │           │
│  └─────────────┘ └─────────────┘ └─────────────┘           │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                   Repository Layer                         │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │
│  │UserReposito │ │AnnouncementR│ │CommentRepos │    ...    │
│  │ry           │ │epository    │ │itory        │           │
│  └─────────────┘ └─────────────┘ └─────────────┘           │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                     Entity Layer                           │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │
│  │User         │ │Announcement │ │Comment      │    ...    │
│  │             │ │             │ │             │           │
│  └─────────────┘ └─────────────┘ └─────────────┘           │
└─────────────────────────────────────────────────────────────┘
```

### 模块化设计

系统采用模块化设计，各模块职责明确，便于维护和扩展：

**核心模块**
- **用户管理模块**：用户注册、登录、权限管理
- **公告管理模块**：公告发布、编辑、状态管理
- **评论系统模块**：评论发表、回复、管理
- **互动功能模块**：点赞、收藏、统计
- **权限控制模块**：基于角色的访问控制

**支撑模块**
- **认证授权模块**：Session管理、权限验证
- **数据访问模块**：数据库操作、事务管理
- **工具类模块**：通用工具、辅助功能
- **配置管理模块**：系统配置、环境管理

---

## 数据库设计详解

### 数据库架构

```
┌─────────────────────────────────────────────────────────────┐
│                    MySQL 8.0 Database                      │
├─────────────────────────────────────────────────────────────┤
│  Character Set: utf8mb4                                     │
│  Collation: utf8mb4_unicode_ci                             │
│  Engine: InnoDB                                            │
│  Transaction Isolation: READ_COMMITTED                     │
└─────────────────────────────────────────────────────────────┘
```

### 核心数据表设计

#### 1. 用户表 (users)

```sql
CREATE TABLE users (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '用户ID',
    username VARCHAR(50) NOT NULL UNIQUE COMMENT '用户名',
    email VARCHAR(100) NOT NULL COMMENT '邮箱地址',
    phone VARCHAR(20) NOT NULL COMMENT '手机号码',
    password VARCHAR(255) NOT NULL COMMENT '加密密码',
    role ENUM('ADMIN', 'TEACHER', 'STUDENT', 'GUEST') NOT NULL DEFAULT 'GUEST' COMMENT '用户角色',
    status ENUM('ACTIVE', 'INACTIVE', 'PENDING', 'LOCKED') NOT NULL DEFAULT 'PENDING' COMMENT '用户状态',
    real_name VARCHAR(100) COMMENT '真实姓名',
    student_id VARCHAR(50) COMMENT '学号/工号',
    department VARCHAR(100) COMMENT '院系/部门',
    description VARCHAR(500) COMMENT '个人描述',
    last_login_time DATETIME COMMENT '最后登录时间',
    login_count INT DEFAULT 0 COMMENT '登录次数',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    
    INDEX idx_username (username),
    INDEX idx_email (email),
    INDEX idx_role (role),
    INDEX idx_status (status),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户信息表';
```

#### 2. 公告表 (announcements)

```sql
CREATE TABLE announcements (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '公告ID',
    title VARCHAR(200) NOT NULL COMMENT '公告标题',
    content TEXT NOT NULL COMMENT '公告内容',
    type ENUM('ANNOUNCEMENT', 'ACTIVITY') NOT NULL COMMENT '类型：公告/活动',
    status ENUM('DRAFT', 'PUBLISHED', 'EXPIRED', 'CANCELLED') NOT NULL DEFAULT 'DRAFT' COMMENT '发布状态',
    publish_time DATETIME NOT NULL COMMENT '发布时间',
    deadline_time DATETIME NULL COMMENT '截止时间',
    publisher VARCHAR(100) NULL COMMENT '发布者姓名',
    summary VARCHAR(500) NULL COMMENT '内容摘要',
    view_count INT DEFAULT 0 COMMENT '浏览次数',
    like_count INT DEFAULT 0 COMMENT '点赞数量',
    comment_count INT DEFAULT 0 COMMENT '评论数量',
    favorite_count INT DEFAULT 0 COMMENT '收藏数量',
    is_important BOOLEAN DEFAULT FALSE COMMENT '是否重要公告',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    
    INDEX idx_type (type),
    INDEX idx_status (status),
    INDEX idx_publish_time (publish_time),
    INDEX idx_is_important (is_important),
    INDEX idx_created_at (created_at),
    FULLTEXT idx_title_content (title, content)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='公告信息表';
```

#### 3. 评论表 (comments)

```sql
CREATE TABLE comments (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '评论ID',
    announcement_id BIGINT NOT NULL COMMENT '公告ID',
    user_id BIGINT NOT NULL COMMENT '用户ID',
    parent_id BIGINT NULL COMMENT '父评论ID（回复）',
    content TEXT NOT NULL COMMENT '评论内容',
    like_count INT DEFAULT 0 COMMENT '点赞数量',
    reply_count INT DEFAULT 0 COMMENT '回复数量',
    is_deleted BOOLEAN DEFAULT FALSE COMMENT '是否已删除',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    
    INDEX idx_announcement_id (announcement_id),
    INDEX idx_user_id (user_id),
    INDEX idx_parent_id (parent_id),
    INDEX idx_created_at (created_at),
    
    FOREIGN KEY (announcement_id) REFERENCES announcements(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (parent_id) REFERENCES comments(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='评论信息表';
```

#### 4. 点赞表 (likes)

```sql
CREATE TABLE likes (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '点赞ID',
    user_id BIGINT NOT NULL COMMENT '用户ID',
    target_type ENUM('ANNOUNCEMENT', 'COMMENT') NOT NULL COMMENT '点赞目标类型',
    target_id BIGINT NOT NULL COMMENT '目标ID',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    
    UNIQUE KEY uk_user_target (user_id, target_type, target_id),
    INDEX idx_target (target_type, target_id),
    INDEX idx_created_at (created_at),
    
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='点赞记录表';
```

#### 5. 收藏表 (favorites)

```sql
CREATE TABLE favorites (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '收藏ID',
    user_id BIGINT NOT NULL COMMENT '用户ID',
    announcement_id BIGINT NOT NULL COMMENT '公告ID',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '收藏时间',
    
    UNIQUE KEY uk_user_announcement (user_id, announcement_id),
    INDEX idx_user_id (user_id),
    INDEX idx_announcement_id (announcement_id),
    INDEX idx_created_at (created_at),
    
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (announcement_id) REFERENCES announcements(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='收藏记录表';
```

### 数据库优化策略

#### 索引优化
1. **主键索引**：所有表都使用自增主键，提供聚簇索引
2. **唯一索引**：用户名、邮箱等唯一字段建立唯一索引
3. **复合索引**：多字段查询建立复合索引
4. **全文索引**：公告标题和内容建立全文索引，支持搜索

#### 查询优化
1. **分页查询**：使用LIMIT和OFFSET进行分页
2. **条件查询**：合理使用WHERE条件，避免全表扫描
3. **连接查询**：适当使用JOIN，避免N+1查询问题
4. **缓存策略**：对热点数据进行缓存

---

## 后端技术实现

### Spring Boot应用架构

#### 主应用类设计

```java
@SpringBootApplication
@EnableJpaRepositories
@EnableTransactionManagement
public class HelloApplication {
    
    public static void main(String[] args) {
        SpringApplication app = new SpringApplication(HelloApplication.class);
        
        // 设置默认配置
        Properties defaultProperties = new Properties();
        defaultProperties.setProperty("server.port", "8080");
        defaultProperties.setProperty("spring.profiles.default", "dev");
        app.setDefaultProperties(defaultProperties);
        
        // 启动应用
        ConfigurableApplicationContext context = app.run(args);
        
        // 输出启动信息
        Environment env = context.getEnvironment();
        String port = env.getProperty("server.port");
        String contextPath = env.getProperty("server.servlet.context-path", "");
        
        System.out.println("=================================");
        System.out.println("应用启动成功！");
        System.out.println("访问地址: http://localhost:" + port + contextPath);
        System.out.println("API文档: http://localhost:" + port + contextPath + "/api");
        System.out.println("=================================");
    }
}
```

#### 配置类设计

**数据库配置类**
```java
@Configuration
@EnableJpaRepositories(basePackages = "com.hello.repository")
@EnableTransactionManagement
public class DatabaseConfig {

    @Bean
    @Primary
    @ConfigurationProperties("spring.datasource")
    public DataSource dataSource() {
        return DataSourceBuilder.create()
                .type(HikariDataSource.class)
                .build();
    }

    @Bean
    public LocalContainerEntityManagerFactoryBean entityManagerFactory(DataSource dataSource) {
        LocalContainerEntityManagerFactoryBean em = new LocalContainerEntityManagerFactoryBean();
        em.setDataSource(dataSource);
        em.setPackagesToScan("com.hello.entity");

        HibernateJpaVendorAdapter vendorAdapter = new HibernateJpaVendorAdapter();
        em.setJpaVendorAdapter(vendorAdapter);

        Properties properties = new Properties();
        properties.setProperty("hibernate.hbm2ddl.auto", "update");
        properties.setProperty("hibernate.dialect", "org.hibernate.dialect.MySQLDialect");
        properties.setProperty("hibernate.show_sql", "false");
        properties.setProperty("hibernate.format_sql", "true");
        properties.setProperty("hibernate.use_sql_comments", "false");
        properties.setProperty("hibernate.jdbc.batch_size", "20");
        properties.setProperty("hibernate.order_inserts", "true");
        properties.setProperty("hibernate.order_updates", "true");
        em.setJpaProperties(properties);

        return em;
    }

    @Bean
    public PlatformTransactionManager transactionManager(EntityManagerFactory entityManagerFactory) {
        JpaTransactionManager transactionManager = new JpaTransactionManager();
        transactionManager.setEntityManagerFactory(entityManagerFactory);
        return transactionManager;
    }
}
```

**Web配置类**
```java
@Configuration
@EnableWebMvc
public class WebConfig implements WebMvcConfigurer {

    @Override
    public void addCorsMappings(CorsRegistry registry) {
        registry.addMapping("/api/**")
                .allowedOriginPatterns("*")
                .allowedMethods("GET", "POST", "PUT", "DELETE", "OPTIONS")
                .allowedHeaders("*")
                .allowCredentials(true)
                .maxAge(3600);
    }

    @Override
    public void addResourceHandlers(ResourceHandlerRegistry registry) {
        registry.addResourceHandler("/static/**")
                .addResourceLocations("classpath:/static/")
                .setCachePeriod(3600)
                .resourceChain(true)
                .addResolver(new PathResourceResolver());
    }

    @Override
    public void configureMessageConverters(List<HttpMessageConverter<?>> converters) {
        MappingJackson2HttpMessageConverter converter = new MappingJackson2HttpMessageConverter();
        ObjectMapper objectMapper = new ObjectMapper();
        objectMapper.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);
        objectMapper.configure(SerializationFeature.WRITE_DATES_AS_TIMESTAMPS, false);
        objectMapper.setDateFormat(new SimpleDateFormat("yyyy-MM-dd HH:mm:ss"));
        converter.setObjectMapper(objectMapper);
        converters.add(0, converter);
    }

    @Bean
    public FilterRegistrationBean<CharacterEncodingFilter> characterEncodingFilter() {
        FilterRegistrationBean<CharacterEncodingFilter> registration = new FilterRegistrationBean<>();
        CharacterEncodingFilter filter = new CharacterEncodingFilter();
        filter.setEncoding("UTF-8");
        filter.setForceEncoding(true);
        registration.setFilter(filter);
        registration.addUrlPatterns("/*");
        return registration;
    }
}
```

### 实体类设计模式

#### 基础实体类
```java
@MappedSuperclass
public abstract class BaseEntity {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(name = "created_at", nullable = false, updatable = false)
    private LocalDateTime createdAt;

    @Column(name = "updated_at", nullable = false)
    private LocalDateTime updatedAt;

    @PrePersist
    protected void onCreate() {
        createdAt = LocalDateTime.now();
        updatedAt = LocalDateTime.now();
    }

    @PreUpdate
    protected void onUpdate() {
        updatedAt = LocalDateTime.now();
    }

    // Getters and Setters
    public Long getId() { return id; }
    public void setId(Long id) { this.id = id; }

    public LocalDateTime getCreatedAt() { return createdAt; }
    public void setCreatedAt(LocalDateTime createdAt) { this.createdAt = createdAt; }

    public LocalDateTime getUpdatedAt() { return updatedAt; }
    public void setUpdatedAt(LocalDateTime updatedAt) { this.updatedAt = updatedAt; }
}
```

#### 用户实体增强设计
```java
@Entity
@Table(name = "users", indexes = {
    @Index(name = "idx_username", columnList = "username"),
    @Index(name = "idx_email", columnList = "email"),
    @Index(name = "idx_role", columnList = "role"),
    @Index(name = "idx_status", columnList = "status")
})
@EntityListeners(AuditingEntityListener.class)
public class User extends BaseEntity {

    @Column(nullable = false, unique = true, length = 50)
    @Size(min = 3, max = 50, message = "用户名长度必须在3-50个字符之间")
    @Pattern(regexp = "^[a-zA-Z0-9_]+$", message = "用户名只能包含字母、数字和下划线")
    private String username;

    @Column(nullable = false, length = 100)
    @Email(message = "邮箱格式不正确")
    @NotBlank(message = "邮箱不能为空")
    private String email;

    @Column(nullable = false, length = 20)
    @Pattern(regexp = "^1[3-9]\\d{9}$", message = "手机号格式不正确")
    private String phone;

    @Column(nullable = false, length = 255)
    @JsonIgnore
    private String password;

    @Enumerated(EnumType.STRING)
    @Column(nullable = false, length = 20)
    private UserRole role = UserRole.GUEST;

    @Enumerated(EnumType.STRING)
    @Column(nullable = false, length = 20)
    private UserStatus status = UserStatus.PENDING;

    @Column(name = "real_name", length = 100)
    @Size(max = 100, message = "真实姓名长度不能超过100个字符")
    private String realName;

    @Column(name = "student_id", length = 50)
    private String studentId;

    @Column(name = "department", length = 100)
    private String department;

    @Column(length = 500)
    @Size(max = 500, message = "个人描述长度不能超过500个字符")
    private String description;

    @Column(name = "last_login_time")
    private LocalDateTime lastLoginTime;

    @Column(name = "login_count")
    private Integer loginCount = 0;

    // 业务方法
    public void incrementLoginCount() {
        if (this.loginCount == null) {
            this.loginCount = 0;
        }
        this.loginCount++;
        this.lastLoginTime = LocalDateTime.now();
    }

    public boolean isActive() {
        return this.status == UserStatus.ACTIVE;
    }

    public boolean hasRole(UserRole role) {
        return this.role == role;
    }

    public boolean isAdmin() {
        return this.role == UserRole.ADMIN;
    }

    public boolean isTeacher() {
        return this.role == UserRole.TEACHER;
    }

    public boolean canManageAnnouncements() {
        return this.role == UserRole.ADMIN || this.role == UserRole.TEACHER;
    }

    public boolean canManageUsers() {
        return this.role == UserRole.ADMIN;
    }

    // 枚举定义
    public enum UserRole {
        ADMIN("管理员", "系统管理员，拥有所有权限"),
        TEACHER("教师", "教师用户，可以发布和管理公告"),
        STUDENT("学生", "学生用户，可以查看和评论公告"),
        GUEST("游客", "游客用户，只能查看公开内容");

        private final String displayName;
        private final String description;

        UserRole(String displayName, String description) {
            this.displayName = displayName;
            this.description = description;
        }

        public String getDisplayName() { return displayName; }
        public String getDescription() { return description; }
    }

    public enum UserStatus {
        ACTIVE("正常", "用户状态正常，可以正常使用系统"),
        INACTIVE("禁用", "用户被禁用，无法登录系统"),
        PENDING("待审核", "新注册用户，等待管理员审核"),
        LOCKED("锁定", "用户被锁定，通常因为违规操作");

        private final String displayName;
        private final String description;

        UserStatus(String displayName, String description) {
            this.displayName = displayName;
            this.description = description;
        }

        public String getDisplayName() { return displayName; }
        public String getDescription() { return description; }
    }

    // Getters and Setters (省略具体实现)
}
```

### 服务层设计模式

#### 基础服务接口
```java
public interface BaseService<T, ID> {

    /**
     * 保存实体
     */
    T save(T entity);

    /**
     * 根据ID查找实体
     */
    Optional<T> findById(ID id);

    /**
     * 查找所有实体
     */
    List<T> findAll();

    /**
     * 分页查找实体
     */
    Page<T> findAll(Pageable pageable);

    /**
     * 根据ID删除实体
     */
    void deleteById(ID id);

    /**
     * 删除实体
     */
    void delete(T entity);

    /**
     * 检查实体是否存在
     */
    boolean existsById(ID id);

    /**
     * 统计实体数量
     */
    long count();
}
```

#### 用户服务实现
```java
@Service
@Transactional
@Slf4j
public class UserService implements BaseService<User, Long> {

    @Autowired
    private UserRepository userRepository;

    @Autowired
    private PasswordEncoder passwordEncoder;

    /**
     * 创建新用户
     */
    @Override
    public User save(User user) {
        validateUser(user);

        // 如果是新用户，加密密码
        if (user.getId() == null && user.getPassword() != null) {
            user.setPassword(passwordEncoder.encode(user.getPassword()));
        }

        // 设置默认值
        if (user.getRole() == null) {
            user.setRole(User.UserRole.GUEST);
        }
        if (user.getStatus() == null) {
            user.setStatus(User.UserStatus.PENDING);
        }
        if (user.getLoginCount() == null) {
            user.setLoginCount(0);
        }

        User savedUser = userRepository.save(user);
        log.info("用户保存成功: {}", savedUser.getUsername());
        return savedUser;
    }

    /**
     * 分页查询用户（支持筛选）
     */
    public Page<User> getAllUsers(int page, int size, String role, String status, String keyword) {
        Pageable pageable = PageRequest.of(page, size, Sort.by(Sort.Direction.DESC, "createdAt"));

        // 构建查询条件
        Specification<User> spec = Specification.where(null);

        if (StringUtils.hasText(role)) {
            spec = spec.and((root, query, cb) ->
                cb.equal(root.get("role"), User.UserRole.valueOf(role)));
        }

        if (StringUtils.hasText(status)) {
            spec = spec.and((root, query, cb) ->
                cb.equal(root.get("status"), User.UserStatus.valueOf(status)));
        }

        if (StringUtils.hasText(keyword)) {
            spec = spec.and((root, query, cb) ->
                cb.or(
                    cb.like(root.get("username"), "%" + keyword + "%"),
                    cb.like(root.get("realName"), "%" + keyword + "%"),
                    cb.like(root.get("email"), "%" + keyword + "%")
                ));
        }

        return userRepository.findAll(spec, pageable);
    }

    /**
     * 根据用户名查找用户
     */
    public Optional<User> findByUsername(String username) {
        return userRepository.findByUsername(username);
    }

    /**
     * 根据邮箱查找用户
     */
    public Optional<User> findByEmail(String email) {
        return userRepository.findByEmail(email);
    }

    /**
     * 验证用户密码
     */
    public boolean validatePassword(User user, String rawPassword) {
        return passwordEncoder.matches(rawPassword, user.getPassword());
    }

    /**
     * 更新用户密码
     */
    public void updatePassword(Long userId, String newPassword) {
        Optional<User> userOpt = userRepository.findById(userId);
        if (userOpt.isPresent()) {
            User user = userOpt.get();
            user.setPassword(passwordEncoder.encode(newPassword));
            userRepository.save(user);
            log.info("用户密码更新成功: {}", user.getUsername());
        }
    }

    /**
     * 更新用户状态
     */
    public void updateUserStatus(Long userId, User.UserStatus status) {
        Optional<User> userOpt = userRepository.findById(userId);
        if (userOpt.isPresent()) {
            User user = userOpt.get();
            user.setStatus(status);
            userRepository.save(user);
            log.info("用户状态更新成功: {} -> {}", user.getUsername(), status);
        }
    }

    /**
     * 获取用户统计信息
     */
    public Map<String, Object> getUserStatistics() {
        Map<String, Object> stats = new HashMap<>();

        stats.put("totalUsers", userRepository.count());
        stats.put("activeUsers", userRepository.countByStatus(User.UserStatus.ACTIVE));
        stats.put("pendingUsers", userRepository.countByStatus(User.UserStatus.PENDING));
        stats.put("adminUsers", userRepository.countByRole(User.UserRole.ADMIN));
        stats.put("teacherUsers", userRepository.countByRole(User.UserRole.TEACHER));
        stats.put("studentUsers", userRepository.countByRole(User.UserRole.STUDENT));

        return stats;
    }

    /**
     * 验证用户数据
     */
    private void validateUser(User user) {
        if (user == null) {
            throw new IllegalArgumentException("用户对象不能为空");
        }

        if (!StringUtils.hasText(user.getUsername())) {
            throw new IllegalArgumentException("用户名不能为空");
        }

        if (!StringUtils.hasText(user.getEmail())) {
            throw new IllegalArgumentException("邮箱不能为空");
        }

        // 检查用户名是否已存在（新用户或用户名变更时）
        if (user.getId() == null || !user.getUsername().equals(getCurrentUsername(user.getId()))) {
            if (userRepository.existsByUsername(user.getUsername())) {
                throw new IllegalArgumentException("用户名已存在");
            }
        }

        // 检查邮箱是否已存在（新用户或邮箱变更时）
        if (user.getId() == null || !user.getEmail().equals(getCurrentEmail(user.getId()))) {
            if (userRepository.existsByEmail(user.getEmail())) {
                throw new IllegalArgumentException("邮箱已存在");
            }
        }
    }

    private String getCurrentUsername(Long userId) {
        return userRepository.findById(userId)
                .map(User::getUsername)
                .orElse(null);
    }

    private String getCurrentEmail(Long userId) {
        return userRepository.findById(userId)
                .map(User::getEmail)
                .orElse(null);
    }

    // 实现BaseService接口的其他方法
    @Override
    public Optional<User> findById(Long id) {
        return userRepository.findById(id);
    }

    @Override
    public List<User> findAll() {
        return userRepository.findAll();
    }

    @Override
    public Page<User> findAll(Pageable pageable) {
        return userRepository.findAll(pageable);
    }

    @Override
    public void deleteById(Long id) {
        userRepository.deleteById(id);
        log.info("用户删除成功: ID={}", id);
    }

    @Override
    public void delete(User user) {
        userRepository.delete(user);
        log.info("用户删除成功: {}", user.getUsername());
    }

    @Override
    public boolean existsById(Long id) {
        return userRepository.existsById(id);
    }

    @Override
    public long count() {
        return userRepository.count();
    }
}
```

### 控制器层设计模式

#### 基础控制器类
```java
@RestController
public abstract class BaseController {

    protected final Logger logger = LoggerFactory.getLogger(getClass());

    /**
     * 统一成功响应
     */
    protected <T> ResponseEntity<ApiResponse<T>> success(T data) {
        return ResponseEntity.ok(ApiResponse.success(data));
    }

    protected <T> ResponseEntity<ApiResponse<T>> success(T data, String message) {
        return ResponseEntity.ok(ApiResponse.success(data, message));
    }

    /**
     * 统一错误响应
     */
    protected <T> ResponseEntity<ApiResponse<T>> error(String message) {
        return ResponseEntity.badRequest().body(ApiResponse.error(message));
    }

    protected <T> ResponseEntity<ApiResponse<T>> error(String message, HttpStatus status) {
        return ResponseEntity.status(status).body(ApiResponse.error(message));
    }

    /**
     * 获取当前登录用户
     */
    protected User getCurrentUser(HttpSession session) {
        return (User) session.getAttribute("currentUser");
    }

    /**
     * 检查用户权限
     */
    protected boolean hasPermission(HttpSession session, User.UserRole... requiredRoles) {
        User currentUser = getCurrentUser(session);
        if (currentUser == null || !currentUser.isActive()) {
            return false;
        }

        return Arrays.stream(requiredRoles)
                .anyMatch(role -> currentUser.getRole() == role);
    }

    /**
     * 统一异常处理
     */
    @ExceptionHandler(IllegalArgumentException.class)
    public ResponseEntity<ApiResponse<Object>> handleIllegalArgumentException(IllegalArgumentException e) {
        logger.warn("参数错误: {}", e.getMessage());
        return error(e.getMessage(), HttpStatus.BAD_REQUEST);
    }

    @ExceptionHandler(AccessDeniedException.class)
    public ResponseEntity<ApiResponse<Object>> handleAccessDeniedException(AccessDeniedException e) {
        logger.warn("访问被拒绝: {}", e.getMessage());
        return error("访问被拒绝", HttpStatus.FORBIDDEN);
    }

    @ExceptionHandler(Exception.class)
    public ResponseEntity<ApiResponse<Object>> handleException(Exception e) {
        logger.error("系统错误", e);
        return error("系统内部错误", HttpStatus.INTERNAL_SERVER_ERROR);
    }
}

/**
 * 统一API响应格式
 */
public class ApiResponse<T> {
    private boolean success;
    private String message;
    private T data;
    private long timestamp;

    private ApiResponse(boolean success, String message, T data) {
        this.success = success;
        this.message = message;
        this.data = data;
        this.timestamp = System.currentTimeMillis();
    }

    public static <T> ApiResponse<T> success(T data) {
        return new ApiResponse<>(true, "操作成功", data);
    }

    public static <T> ApiResponse<T> success(T data, String message) {
        return new ApiResponse<>(true, message, data);
    }

    public static <T> ApiResponse<T> error(String message) {
        return new ApiResponse<>(false, message, null);
    }

    // Getters and Setters
    public boolean isSuccess() { return success; }
    public String getMessage() { return message; }
    public T getData() { return data; }
    public long getTimestamp() { return timestamp; }
}
```

#### 增强的认证控制器
```java
@RestController
@RequestMapping("/api/auth")
@CrossOrigin(origins = "*")
@Validated
public class AuthController extends BaseController {

    @Autowired
    private AuthService authService;

    @Autowired
    private UserService userService;

    /**
     * 用户登录
     */
    @PostMapping("/login")
    public ResponseEntity<ApiResponse<Map<String, Object>>> login(
            @Valid @RequestBody LoginRequest loginRequest,
            HttpSession session,
            HttpServletRequest request) {

        try {
            // 记录登录尝试
            String clientIp = getClientIpAddress(request);
            logger.info("用户登录尝试: username={}, ip={}", loginRequest.getUsername(), clientIp);

            // 执行登录验证
            AuthService.LoginResult result = authService.login(
                loginRequest.getUsername(),
                loginRequest.getPassword()
            );

            if (result.isSuccess()) {
                User user = result.getUser();

                // 更新登录信息
                user.incrementLoginCount();
                userService.save(user);

                // 创建用户会话
                createUserSession(session, user);

                // 构建响应数据
                Map<String, Object> responseData = new HashMap<>();
                responseData.put("user", createUserResponse(user));
                responseData.put("permissions", getUserPermissions(user));
                responseData.put("sessionId", session.getId());

                logger.info("用户登录成功: username={}, role={}", user.getUsername(), user.getRole());
                return success(responseData, "登录成功");

            } else {
                logger.warn("用户登录失败: username={}, reason={}", loginRequest.getUsername(), result.getMessage());
                return error(result.getMessage(), HttpStatus.UNAUTHORIZED);
            }

        } catch (Exception e) {
            logger.error("登录处理异常", e);
            return error("登录失败，请稍后重试", HttpStatus.INTERNAL_SERVER_ERROR);
        }
    }

    /**
     * 用户登出
     */
    @PostMapping("/logout")
    public ResponseEntity<ApiResponse<Object>> logout(HttpSession session) {
        try {
            User currentUser = getCurrentUser(session);
            if (currentUser != null) {
                logger.info("用户登出: username={}", currentUser.getUsername());
            }

            session.invalidate();
            return success(null, "登出成功");

        } catch (Exception e) {
            logger.error("登出处理异常", e);
            return error("登出失败", HttpStatus.INTERNAL_SERVER_ERROR);
        }
    }

    /**
     * 获取当前用户信息
     */
    @GetMapping("/current")
    public ResponseEntity<ApiResponse<Map<String, Object>>> getCurrentUser(HttpSession session) {
        User currentUser = getCurrentUser(session);

        if (currentUser != null && currentUser.isActive()) {
            Map<String, Object> responseData = new HashMap<>();
            responseData.put("user", createUserResponse(currentUser));
            responseData.put("permissions", getUserPermissions(currentUser));
            responseData.put("sessionInfo", getSessionInfo(session));

            return success(responseData);
        } else {
            return error("用户未登录或已失效", HttpStatus.UNAUTHORIZED);
        }
    }

    /**
     * 检查用户权限
     */
    @GetMapping("/check-permission")
    public ResponseEntity<ApiResponse<Map<String, Object>>> checkPermission(
            @RequestParam String resource,
            @RequestParam String action,
            HttpSession session) {

        User currentUser = getCurrentUser(session);
        if (currentUser == null) {
            return error("用户未登录", HttpStatus.UNAUTHORIZED);
        }

        boolean hasPermission = authService.checkPermission(currentUser, resource, action);

        Map<String, Object> result = new HashMap<>();
        result.put("hasPermission", hasPermission);
        result.put("resource", resource);
        result.put("action", action);
        result.put("userRole", currentUser.getRole().name());

        return success(result);
    }

    /**
     * 刷新会话
     */
    @PostMapping("/refresh")
    public ResponseEntity<ApiResponse<Map<String, Object>>> refreshSession(HttpSession session) {
        User currentUser = getCurrentUser(session);

        if (currentUser != null && currentUser.isActive()) {
            // 重新加载用户信息
            Optional<User> userOpt = userService.findById(currentUser.getId());
            if (userOpt.isPresent()) {
                User refreshedUser = userOpt.get();
                createUserSession(session, refreshedUser);

                Map<String, Object> responseData = new HashMap<>();
                responseData.put("user", createUserResponse(refreshedUser));
                responseData.put("permissions", getUserPermissions(refreshedUser));

                return success(responseData, "会话刷新成功");
            }
        }

        return error("会话已失效，请重新登录", HttpStatus.UNAUTHORIZED);
    }

    // 私有辅助方法
    private void createUserSession(HttpSession session, User user) {
        session.setAttribute("currentUser", user);
        session.setAttribute("userId", user.getId());
        session.setAttribute("username", user.getUsername());
        session.setAttribute("userRole", user.getRole().name());
        session.setAttribute("loginTime", LocalDateTime.now());
        session.setMaxInactiveInterval(3600); // 1小时超时
    }

    private Map<String, Object> createUserResponse(User user) {
        Map<String, Object> userResponse = new HashMap<>();
        userResponse.put("id", user.getId());
        userResponse.put("username", user.getUsername());
        userResponse.put("email", user.getEmail());
        userResponse.put("phone", user.getPhone());
        userResponse.put("role", user.getRole().name());
        userResponse.put("roleDisplayName", user.getRole().getDisplayName());
        userResponse.put("status", user.getStatus().name());
        userResponse.put("statusDisplayName", user.getStatus().getDisplayName());
        userResponse.put("realName", user.getRealName());
        userResponse.put("department", user.getDepartment());
        userResponse.put("studentId", user.getStudentId());
        userResponse.put("description", user.getDescription());
        userResponse.put("lastLoginTime", user.getLastLoginTime());
        userResponse.put("loginCount", user.getLoginCount());
        return userResponse;
    }

    private Set<String> getUserPermissions(User user) {
        Set<String> permissions = new HashSet<>();

        // 基础权限
        permissions.add("view_announcements");
        permissions.add("view_activities");
        permissions.add("comment");
        permissions.add("like");
        permissions.add("favorite");

        // 角色特定权限
        switch (user.getRole()) {
            case ADMIN:
                permissions.add("manage_users");
                permissions.add("manage_announcements");
                permissions.add("manage_activities");
                permissions.add("manage_comments");
                permissions.add("view_statistics");
                permissions.add("system_config");
                break;
            case TEACHER:
                permissions.add("create_announcements");
                permissions.add("create_activities");
                permissions.add("manage_own_announcements");
                permissions.add("moderate_comments");
                break;
            case STUDENT:
                permissions.add("view_profile");
                permissions.add("edit_profile");
                break;
            case GUEST:
                // 只有基础权限
                break;
        }

        return permissions;
    }

    private Map<String, Object> getSessionInfo(HttpSession session) {
        Map<String, Object> sessionInfo = new HashMap<>();
        sessionInfo.put("sessionId", session.getId());
        sessionInfo.put("creationTime", new Date(session.getCreationTime()));
        sessionInfo.put("lastAccessedTime", new Date(session.getLastAccessedTime()));
        sessionInfo.put("maxInactiveInterval", session.getMaxInactiveInterval());
        sessionInfo.put("isNew", session.isNew());
        return sessionInfo;
    }

    private String getClientIpAddress(HttpServletRequest request) {
        String xForwardedFor = request.getHeader("X-Forwarded-For");
        if (xForwardedFor != null && !xForwardedFor.isEmpty()) {
            return xForwardedFor.split(",")[0].trim();
        }

        String xRealIp = request.getHeader("X-Real-IP");
        if (xRealIp != null && !xRealIp.isEmpty()) {
            return xRealIp;
        }

        return request.getRemoteAddr();
    }
}

/**
 * 登录请求DTO
 */
public class LoginRequest {

    @NotBlank(message = "用户名不能为空")
    @Size(min = 3, max = 50, message = "用户名长度必须在3-50个字符之间")
    private String username;

    @NotBlank(message = "密码不能为空")
    @Size(min = 6, max = 50, message = "密码长度必须在6-50个字符之间")
    private String password;

    // Getters and Setters
    public String getUsername() { return username; }
    public void setUsername(String username) { this.username = username; }

    public String getPassword() { return password; }
    public void setPassword(String password) { this.password = password; }
}
```

### 数据访问层设计

#### 基础Repository接口
```java
@NoRepositoryBean
public interface BaseRepository<T, ID> extends JpaRepository<T, ID>, JpaSpecificationExecutor<T> {

    /**
     * 根据字段查找实体
     */
    @Query("SELECT e FROM #{#entityName} e WHERE e.#{#fieldName} = :value")
    List<T> findByField(@Param("fieldName") String fieldName, @Param("value") Object value);

    /**
     * 软删除（如果实体支持）
     */
    @Modifying
    @Query("UPDATE #{#entityName} e SET e.deleted = true WHERE e.id = :id")
    void softDeleteById(@Param("id") ID id);

    /**
     * 批量软删除
     */
    @Modifying
    @Query("UPDATE #{#entityName} e SET e.deleted = true WHERE e.id IN :ids")
    void softDeleteByIds(@Param("ids") List<ID> ids);
}
```

#### 用户Repository增强
```java
@Repository
public interface UserRepository extends BaseRepository<User, Long> {

    /**
     * 根据用户名查找用户
     */
    Optional<User> findByUsername(String username);

    /**
     * 根据邮箱查找用户
     */
    Optional<User> findByEmail(String email);

    /**
     * 根据手机号查找用户
     */
    Optional<User> findByPhone(String phone);

    /**
     * 检查用户名是否存在
     */
    boolean existsByUsername(String username);

    /**
     * 检查邮箱是否存在
     */
    boolean existsByEmail(String email);

    /**
     * 根据角色统计用户数量
     */
    long countByRole(User.UserRole role);

    /**
     * 根据状态统计用户数量
     */
    long countByStatus(User.UserStatus status);

    /**
     * 查找指定角色的用户
     */
    List<User> findByRole(User.UserRole role);

    /**
     * 查找指定状态的用户
     */
    List<User> findByStatus(User.UserStatus status);

    /**
     * 查找最近登录的用户
     */
    @Query("SELECT u FROM User u WHERE u.lastLoginTime >= :since ORDER BY u.lastLoginTime DESC")
    List<User> findRecentlyLoggedInUsers(@Param("since") LocalDateTime since);

    /**
     * 查找活跃用户（最近30天有登录）
     */
    @Query("SELECT u FROM User u WHERE u.lastLoginTime >= :thirtyDaysAgo AND u.status = 'ACTIVE'")
    List<User> findActiveUsers(@Param("thirtyDaysAgo") LocalDateTime thirtyDaysAgo);

    /**
     * 根据部门查找用户
     */
    List<User> findByDepartment(String department);

    /**
     * 模糊搜索用户
     */
    @Query("SELECT u FROM User u WHERE " +
           "u.username LIKE %:keyword% OR " +
           "u.realName LIKE %:keyword% OR " +
           "u.email LIKE %:keyword% OR " +
           "u.department LIKE %:keyword%")
    Page<User> searchUsers(@Param("keyword") String keyword, Pageable pageable);

    /**
     * 获取用户统计信息
     */
    @Query("SELECT " +
           "COUNT(u) as totalUsers, " +
           "COUNT(CASE WHEN u.status = 'ACTIVE' THEN 1 END) as activeUsers, " +
           "COUNT(CASE WHEN u.role = 'ADMIN' THEN 1 END) as adminUsers, " +
           "COUNT(CASE WHEN u.role = 'TEACHER' THEN 1 END) as teacherUsers, " +
           "COUNT(CASE WHEN u.role = 'STUDENT' THEN 1 END) as studentUsers " +
           "FROM User u")
    Object[] getUserStatistics();

    /**
     * 查找需要审核的用户
     */
    @Query("SELECT u FROM User u WHERE u.status = 'PENDING' ORDER BY u.createdAt ASC")
    List<User> findPendingUsers();

    /**
     * 更新用户最后登录时间
     */
    @Modifying
    @Query("UPDATE User u SET u.lastLoginTime = :loginTime, u.loginCount = u.loginCount + 1 WHERE u.id = :userId")
    void updateLastLoginTime(@Param("userId") Long userId, @Param("loginTime") LocalDateTime loginTime);
}
```

---

## 前端技术实现

### 前端架构设计

#### 模块化JavaScript架构
```
src/main/resources/static/
├── js/
│   ├── common/                    # 公共模块
│   │   ├── auth.js               # 认证相关
│   │   ├── auth-guard.js         # 权限守卫
│   │   ├── avatar-utils.js       # 头像工具
│   │   └── utils.js              # 通用工具
│   ├── pages/                    # 页面模块
│   │   ├── dashboard.js          # 控制台
│   │   ├── announcements.js      # 公告列表
│   │   ├── announcement-detail.js # 公告详情
│   │   ├── announcement-management.js # 公告管理
│   │   ├── user-management.js    # 用户管理
│   │   └── favorites.js          # 收藏页面
│   └── components/               # 组件模块
│       ├── modal.js              # 模态框组件
│       ├── pagination.js         # 分页组件
│       └── rich-editor.js        # 富文本编辑器
├── css/
│   ├── base/                     # 基础样式
│   │   ├── reset.css            # 重置样式
│   │   ├── variables.css        # CSS变量
│   │   └── mixins.css           # 混合样式
│   ├── components/              # 组件样式
│   │   ├── buttons.css          # 按钮样式
│   │   ├── forms.css            # 表单样式
│   │   ├── tables.css           # 表格样式
│   │   └── modals.css           # 模态框样式
│   └── pages/                   # 页面样式
│       ├── login.css            # 登录页面
│       ├── dashboard.css        # 控制台
│       ├── announcements.css    # 公告页面
│       └── management.css       # 管理页面
└── components/                  # HTML组件
    ├── sidebar.html             # 侧边栏组件
    ├── header.html              # 头部组件
    └── footer.html              # 底部组件
```

### 前端核心工具类

#### 认证工具类 (auth.js)
```javascript
/**
 * 认证相关工具类
 */
class AuthUtils {

    static SESSION_KEY = 'currentUser';
    static TOKEN_KEY = 'authToken';

    /**
     * 用户登录
     */
    static async login(username, password) {
        try {
            const response = await $.ajax({
                url: '/api/auth/login',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ username, password })
            });

            if (response.success) {
                // 存储用户信息
                this.setCurrentUser(response.data.user);
                this.setUserPermissions(response.data.permissions);

                // 触发登录成功事件
                $(document).trigger('userLoggedIn', [response.data.user]);

                return {
                    success: true,
                    user: response.data.user,
                    message: response.message
                };
            } else {
                return {
                    success: false,
                    message: response.message
                };
            }
        } catch (error) {
            console.error('登录请求失败:', error);
            return {
                success: false,
                message: '登录失败，请检查网络连接'
            };
        }
    }

    /**
     * 用户登出
     */
    static async logout() {
        try {
            await $.ajax({
                url: '/api/auth/logout',
                method: 'POST'
            });
        } catch (error) {
            console.error('登出请求失败:', error);
        } finally {
            // 清除本地存储
            this.clearUserData();

            // 触发登出事件
            $(document).trigger('userLoggedOut');

            // 重定向到登录页
            window.location.href = 'index.html';
        }
    }

    /**
     * 获取当前用户
     */
    static getCurrentUser() {
        const userStr = localStorage.getItem(this.SESSION_KEY);
        if (userStr) {
            try {
                return JSON.parse(userStr);
            } catch (error) {
                console.error('解析用户信息失败:', error);
                this.clearUserData();
            }
        }
        return null;
    }

    /**
     * 设置当前用户
     */
    static setCurrentUser(user) {
        localStorage.setItem(this.SESSION_KEY, JSON.stringify(user));
    }

    /**
     * 获取用户权限
     */
    static getUserPermissions() {
        const permissionsStr = localStorage.getItem('userPermissions');
        if (permissionsStr) {
            try {
                return JSON.parse(permissionsStr);
            } catch (error) {
                console.error('解析权限信息失败:', error);
            }
        }
        return [];
    }

    /**
     * 设置用户权限
     */
    static setUserPermissions(permissions) {
        localStorage.setItem('userPermissions', JSON.stringify(permissions));
    }

    /**
     * 检查用户权限
     */
    static hasPermission(permission) {
        const permissions = this.getUserPermissions();
        return permissions.includes(permission);
    }

    /**
     * 检查用户角色
     */
    static hasRole(role) {
        const user = this.getCurrentUser();
        return user && user.role === role;
    }

    /**
     * 检查是否为管理员
     */
    static isAdmin() {
        return this.hasRole('ADMIN');
    }

    /**
     * 检查是否为教师
     */
    static isTeacher() {
        return this.hasRole('TEACHER');
    }

    /**
     * 检查是否可以管理公告
     */
    static canManageAnnouncements() {
        return this.isAdmin() || this.isTeacher();
    }

    /**
     * 检查是否可以管理用户
     */
    static canManageUsers() {
        return this.isAdmin();
    }

    /**
     * 检查用户是否已登录
     */
    static isLoggedIn() {
        const user = this.getCurrentUser();
        return user && user.status === 'ACTIVE';
    }

    /**
     * 清除用户数据
     */
    static clearUserData() {
        localStorage.removeItem(this.SESSION_KEY);
        localStorage.removeItem('userPermissions');
        localStorage.removeItem(this.TOKEN_KEY);
    }

    /**
     * 刷新用户会话
     */
    static async refreshSession() {
        try {
            const response = await $.ajax({
                url: '/api/auth/refresh',
                method: 'POST'
            });

            if (response.success) {
                this.setCurrentUser(response.data.user);
                this.setUserPermissions(response.data.permissions);
                return true;
            }
        } catch (error) {
            console.error('刷新会话失败:', error);
        }

        // 刷新失败，清除数据并重定向
        this.clearUserData();
        window.location.href = 'index.html';
        return false;
    }

    /**
     * 根据角色重定向到相应页面
     */
    static redirectToRolePage(role) {
        const rolePageMap = {
            'ADMIN': 'dashboard.html',
            'TEACHER': 'dashboard.html',
            'STUDENT': 'announcements.html',
            'GUEST': 'announcements.html'
        };

        const targetPage = rolePageMap[role] || 'announcements.html';
        window.location.href = targetPage;
    }
}

// 全局暴露
window.AuthUtils = AuthUtils;

// 页面加载时检查登录状态
$(document).ready(function() {
    // 自动刷新会话（如果用户已登录）
    if (AuthUtils.isLoggedIn()) {
        AuthUtils.refreshSession();
    }
});
```

#### 权限守卫 (auth-guard.js)
```javascript
/**
 * 页面权限守卫
 */
class AuthGuard {

    // 页面权限配置
    static PAGE_PERMISSIONS = {
        'index.html': { requireAuth: false, roles: [] },
        'dashboard.html': { requireAuth: true, roles: ['ADMIN', 'TEACHER', 'STUDENT', 'GUEST'] },
        'announcements.html': { requireAuth: false, roles: ['ADMIN', 'TEACHER', 'STUDENT', 'GUEST'] },
        'announcement-detail.html': { requireAuth: false, roles: ['ADMIN', 'TEACHER', 'STUDENT', 'GUEST'] },
        'announcement-management.html': { requireAuth: true, roles: ['ADMIN', 'TEACHER'] },
        'user-management.html': { requireAuth: true, roles: ['ADMIN'] },
        'favorites.html': { requireAuth: true, roles: ['ADMIN', 'TEACHER', 'STUDENT', 'GUEST'] }
    };

    /**
     * 检查页面访问权限
     */
    static checkPagePermission() {
        const currentPage = this.getCurrentPageName();
        const pageConfig = this.PAGE_PERMISSIONS[currentPage];

        if (!pageConfig) {
            console.warn('未配置页面权限:', currentPage);
            return true; // 默认允许访问
        }

        const user = AuthUtils.getCurrentUser();

        // 检查是否需要登录
        if (pageConfig.requireAuth && !user) {
            this.redirectToLogin('请先登录');
            return false;
        }

        // 检查用户状态
        if (user && user.status !== 'ACTIVE') {
            this.redirectToLogin('账户状态异常，请联系管理员');
            return false;
        }

        // 检查角色权限
        if (pageConfig.roles.length > 0 && user) {
            if (!pageConfig.roles.includes(user.role)) {
                this.showAccessDenied();
                return false;
            }
        }

        return true;
    }

    /**
     * 获取当前页面名称
     */
    static getCurrentPageName() {
        const path = window.location.pathname;
        const pageName = path.substring(path.lastIndexOf('/') + 1);
        return pageName || 'index.html';
    }

    /**
     * 重定向到登录页
     */
    static redirectToLogin(message = '请先登录') {
        if (message) {
            localStorage.setItem('loginMessage', message);
        }

        // 保存当前页面，登录后可以返回
        const currentPage = window.location.href;
        if (!currentPage.includes('index.html')) {
            localStorage.setItem('redirectUrl', currentPage);
        }

        window.location.href = 'index.html';
    }

    /**
     * 显示访问被拒绝消息
     */
    static showAccessDenied() {
        alert('您没有权限访问此页面');
        history.back();
    }

    /**
     * 初始化权限守卫
     */
    static init() {
        // 检查页面权限
        if (!this.checkPagePermission()) {
            return;
        }

        // 如果用户已登录，触发页面初始化事件
        const user = AuthUtils.getCurrentUser();
        if (user) {
            $(document).trigger('pageInitialized', [user]);
        } else {
            // 对于不需要登录的页面，也触发初始化事件
            const currentPage = this.getCurrentPageName();
            const pageConfig = this.PAGE_PERMISSIONS[currentPage];
            if (!pageConfig || !pageConfig.requireAuth) {
                $(document).trigger('pageInitialized', [null]);
            }
        }
    }

    /**
     * 检查功能权限
     */
    static checkFeaturePermission(feature) {
        const user = AuthUtils.getCurrentUser();
        if (!user) {
            return false;
        }

        // 功能权限映射
        const featurePermissions = {
            'create_announcement': ['ADMIN', 'TEACHER'],
            'edit_announcement': ['ADMIN', 'TEACHER'],
            'delete_announcement': ['ADMIN'],
            'manage_users': ['ADMIN'],
            'moderate_comments': ['ADMIN', 'TEACHER'],
            'view_statistics': ['ADMIN']
        };

        const allowedRoles = featurePermissions[feature];
        return allowedRoles && allowedRoles.includes(user.role);
    }

    /**
     * 显示/隐藏基于权限的元素
     */
    static applyElementPermissions() {
        const user = AuthUtils.getCurrentUser();

        // 管理员专用元素
        $('.admin-only').toggle(user && user.role === 'ADMIN');

        // 教师及以上权限元素
        $('.teacher-plus').toggle(user && (user.role === 'ADMIN' || user.role === 'TEACHER'));

        // 登录用户专用元素
        $('.auth-required').toggle(!!user);

        // 游客专用元素
        $('.guest-only').toggle(!user);

        // 根据具体权限显示/隐藏元素
        $('[data-permission]').each(function() {
            const permission = $(this).data('permission');
            const hasPermission = AuthUtils.hasPermission(permission);
            $(this).toggle(hasPermission);
        });

        // 根据角色显示/隐藏元素
        $('[data-role]').each(function() {
            const requiredRoles = $(this).data('role').split(',');
            const hasRole = user && requiredRoles.includes(user.role);
            $(this).toggle(hasRole);
        });
    }
}

// 页面加载时自动执行权限检查
$(document).ready(function() {
    AuthGuard.init();

    // 监听页面初始化事件，应用元素权限
    $(document).on('pageInitialized', function() {
        AuthGuard.applyElementPermissions();
    });
});

// 全局暴露
window.AuthGuard = AuthGuard;
```

#### 通用工具类 (utils.js)
```javascript
/**
 * 通用工具类
 */
class Utils {

    /**
     * HTML转义
     */
    static escapeHtml(text) {
        if (!text) return '';
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, function(m) { return map[m]; });
    }

    /**
     * 格式化日期
     */
    static formatDate(dateStr, format = 'YYYY-MM-DD HH:mm:ss') {
        if (!dateStr) return '';

        const date = new Date(dateStr);
        if (isNaN(date.getTime())) return '';

        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        const seconds = String(date.getSeconds()).padStart(2, '0');

        return format
            .replace('YYYY', year)
            .replace('MM', month)
            .replace('DD', day)
            .replace('HH', hours)
            .replace('mm', minutes)
            .replace('ss', seconds);
    }

    /**
     * 格式化相对时间
     */
    static formatRelativeTime(dateStr) {
        if (!dateStr) return '';

        const date = new Date(dateStr);
        const now = new Date();
        const diff = now.getTime() - date.getTime();

        const minute = 60 * 1000;
        const hour = 60 * minute;
        const day = 24 * hour;
        const week = 7 * day;
        const month = 30 * day;

        if (diff < minute) {
            return '刚刚';
        } else if (diff < hour) {
            return Math.floor(diff / minute) + '分钟前';
        } else if (diff < day) {
            return Math.floor(diff / hour) + '小时前';
        } else if (diff < week) {
            return Math.floor(diff / day) + '天前';
        } else if (diff < month) {
            return Math.floor(diff / week) + '周前';
        } else {
            return this.formatDate(dateStr, 'YYYY-MM-DD');
        }
    }

    /**
     * 显示消息提示
     */
    static showMessage(message, type = 'info', duration = 3000) {
        // 移除现有消息
        $('.message-toast').remove();

        const iconMap = {
            'success': 'fas fa-check-circle',
            'error': 'fas fa-exclamation-circle',
            'warning': 'fas fa-exclamation-triangle',
            'info': 'fas fa-info-circle'
        };

        const toast = $(`
            <div class="message-toast message-${type}">
                <i class="${iconMap[type]}"></i>
                <span>${this.escapeHtml(message)}</span>
                <button class="close-btn">&times;</button>
            </div>
        `);

        // 添加到页面
        $('body').append(toast);

        // 显示动画
        setTimeout(() => toast.addClass('show'), 100);

        // 自动隐藏
        if (duration > 0) {
            setTimeout(() => this.hideMessage(toast), duration);
        }

        // 点击关闭
        toast.find('.close-btn').click(() => this.hideMessage(toast));

        return toast;
    }

    /**
     * 隐藏消息提示
     */
    static hideMessage(toast) {
        toast.removeClass('show');
        setTimeout(() => toast.remove(), 300);
    }

    /**
     * 显示确认对话框
     */
    static showConfirm(message, title = '确认', callback) {
        const modal = $(`
            <div class="modal confirm-modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>${this.escapeHtml(title)}</h3>
                        <button class="modal-close">&times;</button>
                    </div>
                    <div class="modal-body">
                        <p>${this.escapeHtml(message)}</p>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary cancel-btn">取消</button>
                        <button class="btn btn-primary confirm-btn">确认</button>
                    </div>
                </div>
            </div>
        `);

        $('body').append(modal);
        modal.show();

        // 绑定事件
        modal.find('.confirm-btn').click(() => {
            modal.remove();
            if (callback) callback(true);
        });

        modal.find('.cancel-btn, .modal-close').click(() => {
            modal.remove();
            if (callback) callback(false);
        });

        // 点击背景关闭
        modal.click(function(e) {
            if (e.target === this) {
                modal.remove();
                if (callback) callback(false);
            }
        });
    }

    /**
     * 防抖函数
     */
    static debounce(func, wait, immediate) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                timeout = null;
                if (!immediate) func(...args);
            };
            const callNow = immediate && !timeout;
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
            if (callNow) func(...args);
        };
    }

    /**
     * 节流函数
     */
    static throttle(func, limit) {
        let inThrottle;
        return function(...args) {
            if (!inThrottle) {
                func.apply(this, args);
                inThrottle = true;
                setTimeout(() => inThrottle = false, limit);
            }
        };
    }

    /**
     * 深拷贝对象
     */
    static deepClone(obj) {
        if (obj === null || typeof obj !== 'object') return obj;
        if (obj instanceof Date) return new Date(obj.getTime());
        if (obj instanceof Array) return obj.map(item => this.deepClone(item));
        if (typeof obj === 'object') {
            const clonedObj = {};
            for (const key in obj) {
                if (obj.hasOwnProperty(key)) {
                    clonedObj[key] = this.deepClone(obj[key]);
                }
            }
            return clonedObj;
        }
    }

    /**
     * 获取URL参数
     */
    static getUrlParam(name) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(name);
    }

    /**
     * 设置URL参数
     */
    static setUrlParam(name, value) {
        const url = new URL(window.location);
        url.searchParams.set(name, value);
        window.history.replaceState({}, '', url);
    }

    /**
     * 文件大小格式化
     */
    static formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    /**
     * 生成随机ID
     */
    static generateId(length = 8) {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
        let result = '';
        for (let i = 0; i < length; i++) {
            result += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return result;
    }

    /**
     * 验证邮箱格式
     */
    static validateEmail(email) {
        const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return re.test(email);
    }

    /**
     * 验证手机号格式
     */
    static validatePhone(phone) {
        const re = /^1[3-9]\d{9}$/;
        return re.test(phone);
    }
}

// 全局暴露
window.Utils = Utils;

// 添加全局CSS样式
$(document).ready(function() {
    if (!$('#utils-styles').length) {
        $('head').append(`
            <style id="utils-styles">
                .message-toast {
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 12px 16px;
                    border-radius: 4px;
                    color: white;
                    font-size: 14px;
                    z-index: 10000;
                    transform: translateX(100%);
                    transition: transform 0.3s ease;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    min-width: 200px;
                    max-width: 400px;
                }
                .message-toast.show {
                    transform: translateX(0);
                }
                .message-toast.message-success {
                    background-color: #28a745;
                }
                .message-toast.message-error {
                    background-color: #dc3545;
                }
                .message-toast.message-warning {
                    background-color: #ffc107;
                    color: #212529;
                }
                .message-toast.message-info {
                    background-color: #17a2b8;
                }
                .message-toast .close-btn {
                    background: none;
                    border: none;
                    color: inherit;
                    font-size: 18px;
                    cursor: pointer;
                    margin-left: auto;
                    padding: 0;
                    line-height: 1;
                }
                .confirm-modal {
                    display: none;
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background-color: rgba(0, 0, 0, 0.5);
                    z-index: 10001;
                }
                .confirm-modal .modal-content {
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: white;
                    border-radius: 8px;
                    min-width: 300px;
                    max-width: 500px;
                }
                .confirm-modal .modal-header {
                    padding: 16px 20px;
                    border-bottom: 1px solid #eee;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                }
                .confirm-modal .modal-body {
                    padding: 20px;
                }
                .confirm-modal .modal-footer {
                    padding: 16px 20px;
                    border-top: 1px solid #eee;
                    display: flex;
                    justify-content: flex-end;
                    gap: 10px;
                }
            </style>
        `);
    }
});
```

---

## 安全机制设计

### 认证与授权

#### Session管理机制
```java
@Configuration
@EnableWebSecurity
public class SecurityConfig {

    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder(12);
    }

    @Bean
    public SessionRegistry sessionRegistry() {
        return new SessionRegistryImpl();
    }

    @Bean
    public HttpSessionEventPublisher httpSessionEventPublisher() {
        return new HttpSessionEventPublisher();
    }

    @Bean
    public FilterRegistrationBean<SessionValidationFilter> sessionValidationFilter() {
        FilterRegistrationBean<SessionValidationFilter> registration = new FilterRegistrationBean<>();
        registration.setFilter(new SessionValidationFilter());
        registration.addUrlPatterns("/api/*");
        registration.setOrder(1);
        return registration;
    }
}

/**
 * Session验证过滤器
 */
public class SessionValidationFilter implements Filter {

    private static final Set<String> EXCLUDED_PATHS = Set.of(
        "/api/auth/login",
        "/api/auth/logout",
        "/api/announcements",
        "/api/announcements/important"
    );

    @Override
    public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain)
            throws IOException, ServletException {

        HttpServletRequest httpRequest = (HttpServletRequest) request;
        HttpServletResponse httpResponse = (HttpServletResponse) response;

        String requestPath = httpRequest.getRequestURI();

        // 跳过不需要验证的路径
        if (EXCLUDED_PATHS.contains(requestPath) || requestPath.startsWith("/static/")) {
            chain.doFilter(request, response);
            return;
        }

        // 验证Session
        HttpSession session = httpRequest.getSession(false);
        if (session == null || session.getAttribute("currentUser") == null) {
            sendUnauthorizedResponse(httpResponse);
            return;
        }

        // 验证用户状态
        User currentUser = (User) session.getAttribute("currentUser");
        if (!currentUser.isActive()) {
            sendUnauthorizedResponse(httpResponse);
            return;
        }

        // 更新Session最后访问时间
        session.setAttribute("lastAccessTime", LocalDateTime.now());

        chain.doFilter(request, response);
    }

    private void sendUnauthorizedResponse(HttpServletResponse response) throws IOException {
        response.setStatus(HttpStatus.UNAUTHORIZED.value());
        response.setContentType("application/json;charset=UTF-8");
        response.getWriter().write("{\"success\":false,\"message\":\"未授权访问\"}");
    }
}
```

#### 权限控制注解
```java
/**
 * 权限控制注解
 */
@Target({ElementType.METHOD, ElementType.TYPE})
@Retention(RetentionPolicy.RUNTIME)
@Documented
public @interface RequirePermission {

    /**
     * 需要的角色
     */
    User.UserRole[] roles() default {};

    /**
     * 需要的权限
     */
    String[] permissions() default {};

    /**
     * 是否需要登录
     */
    boolean requireAuth() default true;

    /**
     * 错误消息
     */
    String message() default "权限不足";
}

/**
 * 权限控制切面
 */
@Aspect
@Component
@Slf4j
public class PermissionAspect {

    @Autowired
    private AuthService authService;

    @Around("@annotation(requirePermission)")
    public Object checkPermission(ProceedingJoinPoint joinPoint, RequirePermission requirePermission) throws Throwable {

        // 获取当前请求
        RequestAttributes requestAttributes = RequestContextHolder.getRequestAttributes();
        if (requestAttributes == null) {
            throw new AccessDeniedException("无法获取请求上下文");
        }

        HttpServletRequest request = ((ServletRequestAttributes) requestAttributes).getRequest();
        HttpSession session = request.getSession(false);

        // 检查是否需要登录
        if (requirePermission.requireAuth()) {
            if (session == null || session.getAttribute("currentUser") == null) {
                throw new AccessDeniedException("用户未登录");
            }
        }

        User currentUser = (User) session.getAttribute("currentUser");

        // 检查角色权限
        if (requirePermission.roles().length > 0) {
            boolean hasRole = Arrays.stream(requirePermission.roles())
                    .anyMatch(role -> currentUser.getRole() == role);

            if (!hasRole) {
                log.warn("用户 {} 尝试访问需要角色 {} 的资源",
                        currentUser.getUsername(), Arrays.toString(requirePermission.roles()));
                throw new AccessDeniedException(requirePermission.message());
            }
        }

        // 检查具体权限
        if (requirePermission.permissions().length > 0) {
            boolean hasPermission = Arrays.stream(requirePermission.permissions())
                    .allMatch(permission -> authService.hasPermission(currentUser, permission));

            if (!hasPermission) {
                log.warn("用户 {} 尝试访问需要权限 {} 的资源",
                        currentUser.getUsername(), Arrays.toString(requirePermission.permissions()));
                throw new AccessDeniedException(requirePermission.message());
            }
        }

        return joinPoint.proceed();
    }
}
```

### 数据安全

#### SQL注入防护
```java
/**
 * 安全的Repository实现
 */
@Repository
public class SecureUserRepository {

    @PersistenceContext
    private EntityManager entityManager;

    /**
     * 安全的用户搜索（防止SQL注入）
     */
    public Page<User> searchUsersSafely(String keyword, Pageable pageable) {
        // 使用参数化查询防止SQL注入
        String jpql = "SELECT u FROM User u WHERE " +
                     "(:keyword IS NULL OR " +
                     "LOWER(u.username) LIKE LOWER(CONCAT('%', :keyword, '%')) OR " +
                     "LOWER(u.realName) LIKE LOWER(CONCAT('%', :keyword, '%')) OR " +
                     "LOWER(u.email) LIKE LOWER(CONCAT('%', :keyword, '%')))";

        TypedQuery<User> query = entityManager.createQuery(jpql, User.class);
        query.setParameter("keyword", keyword);

        // 分页处理
        query.setFirstResult((int) pageable.getOffset());
        query.setMaxResults(pageable.getPageSize());

        List<User> users = query.getResultList();

        // 计算总数
        String countJpql = "SELECT COUNT(u) FROM User u WHERE " +
                          "(:keyword IS NULL OR " +
                          "LOWER(u.username) LIKE LOWER(CONCAT('%', :keyword, '%')) OR " +
                          "LOWER(u.realName) LIKE LOWER(CONCAT('%', :keyword, '%')) OR " +
                          "LOWER(u.email) LIKE LOWER(CONCAT('%', :keyword, '%')))";

        TypedQuery<Long> countQuery = entityManager.createQuery(countJpql, Long.class);
        countQuery.setParameter("keyword", keyword);
        Long total = countQuery.getSingleResult();

        return new PageImpl<>(users, pageable, total);
    }
}
```

#### XSS防护
```java
/**
 * XSS防护工具类
 */
@Component
public class XssProtectionUtils {

    private static final Policy ANTISAMY_POLICY;

    static {
        try {
            // 加载AntiSamy配置
            InputStream inputStream = XssProtectionUtils.class
                    .getResourceAsStream("/antisamy-policy.xml");
            ANTISAMY_POLICY = Policy.getInstance(inputStream);
        } catch (Exception e) {
            throw new RuntimeException("加载XSS防护配置失败", e);
        }
    }

    /**
     * 清理HTML内容，防止XSS攻击
     */
    public static String cleanHtml(String input) {
        if (input == null || input.trim().isEmpty()) {
            return input;
        }

        try {
            AntiSamy antiSamy = new AntiSamy();
            CleanResults cleanResults = antiSamy.scan(input, ANTISAMY_POLICY);
            return cleanResults.getCleanHTML();
        } catch (Exception e) {
            // 如果清理失败，返回转义后的文本
            return StringEscapeUtils.escapeHtml4(input);
        }
    }

    /**
     * 转义HTML特殊字符
     */
    public static String escapeHtml(String input) {
        if (input == null) {
            return null;
        }
        return StringEscapeUtils.escapeHtml4(input);
    }

    /**
     * 清理用户输入
     */
    public static String sanitizeInput(String input) {
        if (input == null) {
            return null;
        }

        // 移除潜在的恶意字符
        String cleaned = input.replaceAll("[<>\"'%;()&+]", "");

        // 限制长度
        if (cleaned.length() > 1000) {
            cleaned = cleaned.substring(0, 1000);
        }

        return cleaned.trim();
    }
}

/**
 * 请求参数XSS过滤器
 */
public class XssFilter implements Filter {

    @Override
    public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain)
            throws IOException, ServletException {

        XssHttpServletRequestWrapper wrappedRequest = new XssHttpServletRequestWrapper(
                (HttpServletRequest) request);

        chain.doFilter(wrappedRequest, response);
    }
}

/**
 * XSS请求包装器
 */
public class XssHttpServletRequestWrapper extends HttpServletRequestWrapper {

    public XssHttpServletRequestWrapper(HttpServletRequest request) {
        super(request);
    }

    @Override
    public String getParameter(String name) {
        String value = super.getParameter(name);
        return XssProtectionUtils.cleanHtml(value);
    }

    @Override
    public String[] getParameterValues(String name) {
        String[] values = super.getParameterValues(name);
        if (values == null) {
            return null;
        }

        String[] cleanValues = new String[values.length];
        for (int i = 0; i < values.length; i++) {
            cleanValues[i] = XssProtectionUtils.cleanHtml(values[i]);
        }
        return cleanValues;
    }

    @Override
    public String getHeader(String name) {
        String value = super.getHeader(name);
        return XssProtectionUtils.cleanHtml(value);
    }
}
```

#### 数据加密
```java
/**
 * 数据加密工具类
 */
@Component
public class EncryptionUtils {

    private static final String AES_ALGORITHM = "AES/CBC/PKCS5Padding";
    private static final String KEY_ALGORITHM = "AES";

    @Value("${app.encryption.secret-key}")
    private String secretKey;

    /**
     * 加密敏感数据
     */
    public String encrypt(String plainText) {
        try {
            SecretKeySpec keySpec = new SecretKeySpec(secretKey.getBytes(), KEY_ALGORITHM);
            Cipher cipher = Cipher.getInstance(AES_ALGORITHM);

            // 生成随机IV
            byte[] iv = new byte[16];
            new SecureRandom().nextBytes(iv);
            IvParameterSpec ivSpec = new IvParameterSpec(iv);

            cipher.init(Cipher.ENCRYPT_MODE, keySpec, ivSpec);
            byte[] encrypted = cipher.doFinal(plainText.getBytes(StandardCharsets.UTF_8));

            // 将IV和加密数据组合
            byte[] result = new byte[iv.length + encrypted.length];
            System.arraycopy(iv, 0, result, 0, iv.length);
            System.arraycopy(encrypted, 0, result, iv.length, encrypted.length);

            return Base64.getEncoder().encodeToString(result);
        } catch (Exception e) {
            throw new RuntimeException("数据加密失败", e);
        }
    }

    /**
     * 解密敏感数据
     */
    public String decrypt(String encryptedText) {
        try {
            byte[] data = Base64.getDecoder().decode(encryptedText);

            // 提取IV和加密数据
            byte[] iv = new byte[16];
            byte[] encrypted = new byte[data.length - 16];
            System.arraycopy(data, 0, iv, 0, 16);
            System.arraycopy(data, 16, encrypted, 0, encrypted.length);

            SecretKeySpec keySpec = new SecretKeySpec(secretKey.getBytes(), KEY_ALGORITHM);
            Cipher cipher = Cipher.getInstance(AES_ALGORITHM);
            IvParameterSpec ivSpec = new IvParameterSpec(iv);

            cipher.init(Cipher.DECRYPT_MODE, keySpec, ivSpec);
            byte[] decrypted = cipher.doFinal(encrypted);

            return new String(decrypted, StandardCharsets.UTF_8);
        } catch (Exception e) {
            throw new RuntimeException("数据解密失败", e);
        }
    }

    /**
     * 生成安全的随机密码
     */
    public String generateSecurePassword(int length) {
        String chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*";
        SecureRandom random = new SecureRandom();
        StringBuilder password = new StringBuilder();

        for (int i = 0; i < length; i++) {
            password.append(chars.charAt(random.nextInt(chars.length())));
        }

        return password.toString();
    }

    /**
     * 哈希密码
     */
    public String hashPassword(String password) {
        BCryptPasswordEncoder encoder = new BCryptPasswordEncoder(12);
        return encoder.encode(password);
    }

    /**
     * 验证密码
     */
    public boolean verifyPassword(String password, String hashedPassword) {
        BCryptPasswordEncoder encoder = new BCryptPasswordEncoder();
        return encoder.matches(password, hashedPassword);
    }
}
```

---

## 性能优化策略

### 数据库优化

#### 连接池配置
```properties
# HikariCP连接池配置
spring.datasource.hikari.minimum-idle=5
spring.datasource.hikari.maximum-pool-size=20
spring.datasource.hikari.idle-timeout=300000
spring.datasource.hikari.max-lifetime=1200000
spring.datasource.hikari.connection-timeout=20000
spring.datasource.hikari.validation-timeout=3000
spring.datasource.hikari.leak-detection-threshold=60000

# 连接池监控
spring.datasource.hikari.register-mbeans=true
management.endpoints.web.exposure.include=health,info,metrics
management.endpoint.health.show-details=always
```

#### 查询优化
```java
/**
 * 查询优化服务
 */
@Service
public class OptimizedQueryService {

    @PersistenceContext
    private EntityManager entityManager;

    /**
     * 批量查询优化
     */
    @Transactional(readOnly = true)
    public List<AnnouncementDTO> getAnnouncementsWithDetails(List<Long> ids) {
        // 使用一次查询获取所有数据，避免N+1问题
        String jpql = "SELECT new com.hello.dto.AnnouncementDTO(" +
                     "a.id, a.title, a.content, a.type, a.status, " +
                     "a.publishTime, a.publisher, a.viewCount, " +
                     "a.likeCount, a.commentCount, a.favoriteCount) " +
                     "FROM Announcement a WHERE a.id IN :ids";

        return entityManager.createQuery(jpql, AnnouncementDTO.class)
                .setParameter("ids", ids)
                .getResultList();
    }

    /**
     * 分页查询优化
     */
    @Transactional(readOnly = true)
    public Page<Announcement> getAnnouncementsOptimized(Pageable pageable, String type, String status) {
        // 构建动态查询
        CriteriaBuilder cb = entityManager.getCriteriaBuilder();
        CriteriaQuery<Announcement> query = cb.createQuery(Announcement.class);
        Root<Announcement> root = query.from(Announcement.class);

        List<Predicate> predicates = new ArrayList<>();

        if (type != null) {
            predicates.add(cb.equal(root.get("type"), Announcement.AnnouncementType.valueOf(type)));
        }

        if (status != null) {
            predicates.add(cb.equal(root.get("status"), Announcement.AnnouncementStatus.valueOf(status)));
        }

        query.where(predicates.toArray(new Predicate[0]));
        query.orderBy(cb.desc(root.get("publishTime")));

        TypedQuery<Announcement> typedQuery = entityManager.createQuery(query);
        typedQuery.setFirstResult((int) pageable.getOffset());
        typedQuery.setMaxResults(pageable.getPageSize());

        List<Announcement> content = typedQuery.getResultList();

        // 计算总数
        CriteriaQuery<Long> countQuery = cb.createQuery(Long.class);
        Root<Announcement> countRoot = countQuery.from(Announcement.class);
        countQuery.select(cb.count(countRoot));
        countQuery.where(predicates.toArray(new Predicate[0]));

        Long total = entityManager.createQuery(countQuery).getSingleResult();

        return new PageImpl<>(content, pageable, total);
    }
}
```

### 缓存策略

#### Redis缓存配置
```java
@Configuration
@EnableCaching
public class CacheConfig {

    @Bean
    public CacheManager cacheManager(RedisConnectionFactory connectionFactory) {
        RedisCacheConfiguration config = RedisCacheConfiguration.defaultCacheConfig()
                .entryTtl(Duration.ofMinutes(30))
                .serializeKeysWith(RedisSerializationContext.SerializationPair
                        .fromSerializer(new StringRedisSerializer()))
                .serializeValuesWith(RedisSerializationContext.SerializationPair
                        .fromSerializer(new GenericJackson2JsonRedisSerializer()));

        return RedisCacheManager.builder(connectionFactory)
                .cacheDefaults(config)
                .build();
    }

    @Bean
    public RedisTemplate<String, Object> redisTemplate(RedisConnectionFactory connectionFactory) {
        RedisTemplate<String, Object> template = new RedisTemplate<>();
        template.setConnectionFactory(connectionFactory);

        // 设置序列化器
        template.setKeySerializer(new StringRedisSerializer());
        template.setValueSerializer(new GenericJackson2JsonRedisSerializer());
        template.setHashKeySerializer(new StringRedisSerializer());
        template.setHashValueSerializer(new GenericJackson2JsonRedisSerializer());

        template.afterPropertiesSet();
        return template;
    }
}

/**
 * 缓存服务
 */
@Service
public class CacheService {

    @Autowired
    private RedisTemplate<String, Object> redisTemplate;

    /**
     * 缓存公告列表
     */
    @Cacheable(value = "announcements", key = "#page + '_' + #size + '_' + #type + '_' + #status")
    public Page<Announcement> getCachedAnnouncements(int page, int size, String type, String status) {
        // 实际查询逻辑
        return announcementService.getAllAnnouncements(page, size, status, type);
    }

    /**
     * 缓存用户信息
     */
    @Cacheable(value = "users", key = "#userId")
    public User getCachedUser(Long userId) {
        return userService.findById(userId).orElse(null);
    }

    /**
     * 清除缓存
     */
    @CacheEvict(value = "announcements", allEntries = true)
    public void clearAnnouncementCache() {
        // 清除公告缓存
    }

    /**
     * 更新缓存
     */
    @CachePut(value = "users", key = "#user.id")
    public User updateUserCache(User user) {
        return user;
    }
}
```

### 前端性能优化

#### 资源优化
```javascript
/**
 * 前端性能优化工具
 */
class PerformanceOptimizer {

    /**
     * 图片懒加载
     */
    static initLazyLoading() {
        const images = document.querySelectorAll('img[data-src]');

        const imageObserver = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    img.src = img.dataset.src;
                    img.classList.remove('lazy');
                    observer.unobserve(img);
                }
            });
        });

        images.forEach(img => imageObserver.observe(img));
    }

    /**
     * 防抖搜索
     */
    static debounceSearch(searchInput, searchFunction, delay = 300) {
        let timeoutId;

        searchInput.addEventListener('input', function() {
            clearTimeout(timeoutId);
            timeoutId = setTimeout(() => {
                searchFunction(this.value);
            }, delay);
        });
    }

    /**
     * 虚拟滚动（大列表优化）
     */
    static createVirtualScroll(container, items, itemHeight, renderItem) {
        const containerHeight = container.clientHeight;
        const visibleCount = Math.ceil(containerHeight / itemHeight) + 2;
        let startIndex = 0;

        const scrollContent = document.createElement('div');
        scrollContent.style.height = `${items.length * itemHeight}px`;
        container.appendChild(scrollContent);

        const visibleItems = document.createElement('div');
        visibleItems.style.position = 'absolute';
        visibleItems.style.top = '0';
        visibleItems.style.width = '100%';
        container.appendChild(visibleItems);

        function updateVisibleItems() {
            const scrollTop = container.scrollTop;
            startIndex = Math.floor(scrollTop / itemHeight);
            const endIndex = Math.min(startIndex + visibleCount, items.length);

            visibleItems.innerHTML = '';
            visibleItems.style.transform = `translateY(${startIndex * itemHeight}px)`;

            for (let i = startIndex; i < endIndex; i++) {
                const itemElement = renderItem(items[i], i);
                itemElement.style.height = `${itemHeight}px`;
                visibleItems.appendChild(itemElement);
            }
        }

        container.addEventListener('scroll', Utils.throttle(updateVisibleItems, 16));
        updateVisibleItems();
    }

    /**
     * 预加载关键资源
     */
    static preloadResources(urls) {
        urls.forEach(url => {
            const link = document.createElement('link');
            link.rel = 'prefetch';
            link.href = url;
            document.head.appendChild(link);
        });
    }

    /**
     * 代码分割和动态导入
     */
    static async loadModule(moduleName) {
        try {
            const module = await import(`./modules/${moduleName}.js`);
            return module.default || module;
        } catch (error) {
            console.error(`加载模块 ${moduleName} 失败:`, error);
            throw error;
        }
    }

    /**
     * 性能监控
     */
    static monitorPerformance() {
        // 监控页面加载性能
        window.addEventListener('load', () => {
            const perfData = performance.getEntriesByType('navigation')[0];
            const loadTime = perfData.loadEventEnd - perfData.fetchStart;

            console.log('页面加载时间:', loadTime + 'ms');

            // 发送性能数据到服务器
            this.sendPerformanceData({
                loadTime,
                domContentLoaded: perfData.domContentLoadedEventEnd - perfData.fetchStart,
                firstPaint: performance.getEntriesByType('paint')[0]?.startTime || 0
            });
        });

        // 监控资源加载
        const observer = new PerformanceObserver((list) => {
            list.getEntries().forEach((entry) => {
                if (entry.duration > 1000) {
                    console.warn('慢资源:', entry.name, entry.duration + 'ms');
                }
            });
        });

        observer.observe({ entryTypes: ['resource'] });
    }

    /**
     * 发送性能数据
     */
    static sendPerformanceData(data) {
        if (navigator.sendBeacon) {
            navigator.sendBeacon('/api/performance', JSON.stringify(data));
        } else {
            fetch('/api/performance', {
                method: 'POST',
                body: JSON.stringify(data),
                headers: { 'Content-Type': 'application/json' }
            }).catch(console.error);
        }
    }
}

// 页面加载时初始化性能优化
$(document).ready(function() {
    PerformanceOptimizer.initLazyLoading();
    PerformanceOptimizer.monitorPerformance();

    // 预加载关键资源
    PerformanceOptimizer.preloadResources([
        '/css/styles.css',
        '/js/utils.js',
        '/images/avatar.webp'
    ]);
});
```

---

## Docker容器化部署

### 多阶段构建Dockerfile

```dockerfile
# 多阶段构建 - 构建阶段
FROM maven:3.8.6-openjdk-17-slim AS builder

# 设置工作目录
WORKDIR /app

# 复制pom.xml和源代码
COPY pom.xml .
COPY src ./src

# 设置Maven配置
RUN mkdir -p /root/.m2 && \
    echo '<settings><mirrors><mirror><id>aliyun</id><name>Aliyun Mirror</name><url>https://maven.aliyun.com/repository/public</url><mirrorOf>central</mirrorOf></mirror></mirrors></settings>' > /root/.m2/settings.xml

# 构建应用
RUN mvn clean package -DskipTests -Dmaven.compile.fork=true

# 运行阶段
FROM openjdk:17-jre-slim

# 安装必要的工具和字体
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        curl \
        wget \
        fontconfig \
        fonts-dejavu-core \
        fonts-liberation \
        ca-certificates && \
    rm -rf /var/lib/apt/lists/*

# 创建非root用户
RUN groupadd -r appuser && \
    useradd -r -g appuser -d /app -s /bin/bash appuser

# 设置工作目录
WORKDIR /app

# 从构建阶段复制jar文件
COPY --from=builder /app/target/*.jar app.jar

# 创建日志目录
RUN mkdir -p /app/logs && \
    chown -R appuser:appuser /app

# 切换到非root用户
USER appuser

# 设置JVM参数
ENV JAVA_OPTS="-Xms512m -Xmx1024m -XX:+UseG1GC -XX:G1HeapRegionSize=16m -XX:+UseStringDeduplication -Dfile.encoding=UTF-8 -Duser.timezone=Asia/Shanghai"

# 健康检查
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:8081/actuator/health || exit 1

# 暴露端口
EXPOSE 8081

# 启动应用
ENTRYPOINT ["sh", "-c", "java $JAVA_OPTS -jar app.jar"]
```

### Docker Compose生产配置

```yaml
version: '3.8'

services:
  # MySQL数据库
  mysql:
    image: mysql:8.0
    container_name: campus-mysql-prod
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      TZ: Asia/Shanghai
    ports:
      - "${MYSQL_PORT:-3307}:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./docker/mysql/conf.d:/etc/mysql/conf.d:ro
      - ./docker/mysql/init:/docker-entrypoint-initdb.d:ro
      - ./backups:/backups
    command: >
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_unicode_ci
      --default-authentication-plugin=mysql_native_password
      --innodb-buffer-pool-size=256M
      --innodb-log-file-size=64M
      --max-connections=200
      --query-cache-size=0
      --query-cache-type=0
    networks:
      - campus-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      timeout: 20s
      retries: 10

  # Redis缓存
  redis:
    image: redis:7-alpine
    container_name: campus-redis-prod
    restart: unless-stopped
    command: >
      --requirepass ${REDIS_PASSWORD}
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    networks:
      - campus-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Spring Boot应用
  app:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - BUILD_DATE=${BUILD_DATE}
        - VCS_REF=${VCS_REF}
    image: campus-app:${APP_VERSION:-latest}
    container_name: campus-app-prod
    restart: unless-stopped
    environment:
      # 数据库配置
      DB_HOST: mysql
      DB_PORT: 3306
      DB_NAME: ${MYSQL_DATABASE}
      DB_USERNAME: ${MYSQL_USER}
      DB_PASSWORD: ${MYSQL_PASSWORD}

      # Redis配置
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD}

      # 应用配置
      APP_NAME: campus-announcement-system
      SERVER_PORT: 8081
      SPRING_PROFILES_ACTIVE: docker,prod

      # JPA配置
      JPA_DDL_AUTO: validate
      JPA_SHOW_SQL: "false"

      # 日志配置
      LOG_LEVEL_ROOT: WARN
      LOG_LEVEL_APP: INFO

      # 安全配置
      ENCRYPTION_SECRET_KEY: ${ENCRYPTION_SECRET_KEY}
      JWT_SECRET: ${JWT_SECRET}

      # 性能配置
      HIKARI_MINIMUM_IDLE: 5
      HIKARI_MAXIMUM_POOL_SIZE: 20

    ports:
      - "${APP_PORT:-8081}:8081"
    volumes:
      - ./logs:/app/logs
      - ./uploads:/app/uploads
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - campus-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Nginx反向代理
  nginx:
    image: nginx:alpine
    container_name: campus-nginx-prod
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./docker/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./docker/nginx/conf.d:/etc/nginx/conf.d:ro
      - ./docker/nginx/ssl:/etc/nginx/ssl:ro
      - ./docker/nginx/logs:/var/log/nginx
      - ./static:/usr/share/nginx/html/static:ro
    depends_on:
      app:
        condition: service_healthy
    networks:
      - campus-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # 监控服务
  prometheus:
    image: prom/prometheus:latest
    container_name: campus-prometheus
    restart: unless-stopped
    ports:
      - "9090:9090"
    volumes:
      - ./docker/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=200h'
      - '--web.enable-lifecycle'
    networks:
      - campus-network

  # 日志收集
  filebeat:
    image: docker.elastic.co/beats/filebeat:8.5.0
    container_name: campus-filebeat
    restart: unless-stopped
    user: root
    volumes:
      - ./docker/filebeat/filebeat.yml:/usr/share/filebeat/filebeat.yml:ro
      - ./logs:/var/log/app:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      - ELASTICSEARCH_HOST=${ELASTICSEARCH_HOST:-localhost:9200}
    networks:
      - campus-network
    depends_on:
      - app

networks:
  campus-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

volumes:
  mysql_data:
    driver: local
  redis_data:
    driver: local
  prometheus_data:
    driver: local
```

### 部署脚本

```bash
#!/bin/bash

# 生产环境部署脚本
set -e

# 颜色定义
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# 日志函数
log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# 配置变量
PROJECT_NAME="campus-announcement-system"
DOCKER_COMPOSE_FILE="docker-compose.prod.yml"
ENV_FILE=".env.prod"
BACKUP_DIR="./backups"
LOG_DIR="./logs"

# 检查必要的工具
check_requirements() {
    log_info "检查部署环境..."

    if ! command -v docker &> /dev/null; then
        log_error "Docker 未安装"
        exit 1
    fi

    if ! command -v docker-compose &> /dev/null; then
        log_error "Docker Compose 未安装"
        exit 1
    fi

    log_success "环境检查通过"
}

# 创建必要的目录
create_directories() {
    log_info "创建必要的目录..."

    mkdir -p $BACKUP_DIR
    mkdir -p $LOG_DIR
    mkdir -p ./docker/mysql/conf.d
    mkdir -p ./docker/mysql/init
    mkdir -p ./docker/nginx/conf.d
    mkdir -p ./docker/nginx/ssl
    mkdir -p ./docker/nginx/logs
    mkdir -p ./uploads

    log_success "目录创建完成"
}

# 生成环境配置文件
generate_env_file() {
    if [ ! -f $ENV_FILE ]; then
        log_info "生成环境配置文件..."

        cat > $ENV_FILE << EOF
# 数据库配置
MYSQL_ROOT_PASSWORD=$(openssl rand -base64 32)
MYSQL_DATABASE=campus_db_prod
MYSQL_USER=campus_user
MYSQL_PASSWORD=$(openssl rand -base64 32)
MYSQL_PORT=3307

# Redis配置
REDIS_PASSWORD=$(openssl rand -base64 32)
REDIS_PORT=6379

# 应用配置
APP_VERSION=latest
APP_PORT=8081
BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
VCS_REF=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")

# 安全配置
ENCRYPTION_SECRET_KEY=$(openssl rand -base64 32)
JWT_SECRET=$(openssl rand -base64 64)

# 监控配置
ELASTICSEARCH_HOST=localhost:9200
EOF

        log_success "环境配置文件生成完成"
    else
        log_info "环境配置文件已存在"
    fi
}

# 备份数据库
backup_database() {
    if [ "$1" = "true" ]; then
        log_info "备份数据库..."

        BACKUP_FILE="$BACKUP_DIR/backup_$(date +%Y%m%d_%H%M%S).sql"

        docker-compose -f $DOCKER_COMPOSE_FILE exec mysql mysqldump \
            -u root -p$MYSQL_ROOT_PASSWORD \
            --single-transaction \
            --routines \
            --triggers \
            $MYSQL_DATABASE > $BACKUP_FILE

        if [ $? -eq 0 ]; then
            log_success "数据库备份完成: $BACKUP_FILE"
        else
            log_error "数据库备份失败"
            exit 1
        fi
    fi
}

# 构建和部署
deploy() {
    log_info "开始部署 $PROJECT_NAME..."

    # 拉取最新代码
    if [ -d ".git" ]; then
        log_info "拉取最新代码..."
        git pull origin main
    fi

    # 构建镜像
    log_info "构建Docker镜像..."
    docker-compose -f $DOCKER_COMPOSE_FILE build --no-cache

    # 启动服务
    log_info "启动服务..."
    docker-compose -f $DOCKER_COMPOSE_FILE up -d

    # 等待服务启动
    log_info "等待服务启动..."
    sleep 30

    # 健康检查
    health_check
}

# 健康检查
health_check() {
    log_info "执行健康检查..."

    local max_attempts=30
    local attempt=1

    while [ $attempt -le $max_attempts ]; do
        if curl -f http://localhost:8081/actuator/health &> /dev/null; then
            log_success "应用健康检查通过"
            return 0
        fi

        log_info "健康检查失败，重试 ($attempt/$max_attempts)..."
        sleep 10
        ((attempt++))
    done

    log_error "应用健康检查失败"
    show_logs
    exit 1
}

# 显示日志
show_logs() {
    log_info "显示应用日志..."
    docker-compose -f $DOCKER_COMPOSE_FILE logs --tail=50 app
}

# 停止服务
stop_services() {
    log_info "停止服务..."
    docker-compose -f $DOCKER_COMPOSE_FILE down
    log_success "服务已停止"
}

# 清理资源
cleanup() {
    log_info "清理Docker资源..."
    docker system prune -f
    docker volume prune -f
    log_success "清理完成"
}

# 显示状态
show_status() {
    log_info "服务状态:"
    docker-compose -f $DOCKER_COMPOSE_FILE ps

    log_info "资源使用情况:"
    docker stats --no-stream
}

# 主函数
main() {
    case "$1" in
        "deploy")
            check_requirements
            create_directories
            generate_env_file
            backup_database "${2:-false}"
            deploy
            log_success "部署完成！"
            log_info "访问地址: http://localhost"
            ;;
        "stop")
            stop_services
            ;;
        "restart")
            stop_services
            sleep 5
            deploy
            ;;
        "backup")
            backup_database "true"
            ;;
        "logs")
            show_logs
            ;;
        "status")
            show_status
            ;;
        "cleanup")
            cleanup
            ;;
        "health")
            health_check
            ;;
        *)
            echo "用法: $0 {deploy|stop|restart|backup|logs|status|cleanup|health}"
            echo ""
            echo "命令说明:"
            echo "  deploy  - 部署应用 (可选参数: backup=true 部署前备份数据库)"
            echo "  stop    - 停止所有服务"
            echo "  restart - 重启所有服务"
            echo "  backup  - 备份数据库"
            echo "  logs    - 查看应用日志"
            echo "  status  - 查看服务状态"
            echo "  cleanup - 清理Docker资源"
            echo "  health  - 健康检查"
            echo ""
            echo "示例:"
            echo "  $0 deploy          # 部署应用"
            echo "  $0 deploy backup   # 部署前备份数据库"
            echo "  $0 logs            # 查看日志"
            exit 1
            ;;
    esac
}

# 执行主函数
main "$@"
```

---

## API接口文档

### 认证接口

#### POST /api/auth/login
**描述**: 用户登录

**请求参数**:
```json
{
    "username": "string",
    "password": "string"
}
```

**响应示例**:
```json
{
    "success": true,
    "message": "登录成功",
    "data": {
        "user": {
            "id": 1,
            "username": "admin",
            "email": "admin@example.com",
            "role": "ADMIN",
            "status": "ACTIVE"
        },
        "permissions": ["manage_users", "manage_announcements"],
        "sessionId": "ABC123"
    },
    "timestamp": 1640995200000
}
```

#### POST /api/auth/logout
**描述**: 用户登出

**响应示例**:
```json
{
    "success": true,
    "message": "登出成功",
    "timestamp": 1640995200000
}
```

### 用户管理接口

#### GET /api/users
**描述**: 获取用户列表（分页）

**查询参数**:
- `page`: 页码（从0开始）
- `size`: 每页大小
- `role`: 角色筛选
- `status`: 状态筛选
- `keyword`: 关键词搜索

**响应示例**:
```json
{
    "content": [
        {
            "id": 1,
            "username": "admin",
            "email": "admin@example.com",
            "role": "ADMIN",
            "status": "ACTIVE",
            "createdAt": "2024-01-01T00:00:00"
        }
    ],
    "pageable": {
        "page": 0,
        "size": 10
    },
    "totalElements": 100,
    "totalPages": 10
}
```

#### POST /api/users
**描述**: 创建用户

**请求参数**:
```json
{
    "username": "string",
    "email": "string",
    "phone": "string",
    "password": "string",
    "role": "STUDENT",
    "realName": "string",
    "department": "string"
}
```

### 公告管理接口

#### GET /api/announcements
**描述**: 获取公告列表（分页）

**查询参数**:
- `page`: 页码
- `size`: 每页大小
- `type`: 类型筛选（ANNOUNCEMENT/ACTIVITY）
- `status`: 状态筛选
- `keyword`: 关键词搜索

#### POST /api/announcements
**描述**: 创建公告

**请求参数**:
```json
{
    "title": "string",
    "content": "string",
    "type": "ANNOUNCEMENT",
    "status": "DRAFT",
    "publishTime": "2024-01-01T00:00:00",
    "deadlineTime": "2024-01-31T23:59:59",
    "isImportant": false
}
```

#### PUT /api/announcements/{id}/publish
**描述**: 发布公告

#### PUT /api/announcements/{id}/cancel
**描述**: 取消发布公告

### 评论接口

#### GET /api/comments/announcement/{announcementId}
**描述**: 获取公告评论列表

#### POST /api/comments
**描述**: 发表评论

**请求参数**:
```json
{
    "announcementId": 1,
    "userId": 1,
    "content": "string",
    "parentId": null
}
```

### 互动接口

#### POST /api/likes
**描述**: 点赞/取消点赞

**请求参数**:
```json
{
    "userId": 1,
    "targetType": "ANNOUNCEMENT",
    "targetId": 1
}
```

#### POST /api/favorites
**描述**: 收藏/取消收藏

**请求参数**:
```json
{
    "userId": 1,
    "announcementId": 1
}
```

---

## 总结

本技术实现文档详细介绍了校园公告系统的技术架构、核心实现和部署方案。系统采用现代化的技术栈，具备以下特点：

### 技术优势
1. **架构清晰**: 采用分层架构和模块化设计，代码结构清晰
2. **性能优良**: 通过数据库优化、缓存策略和前端优化提升性能
3. **安全可靠**: 实现了完整的安全机制，包括认证、授权、数据加密等
4. **易于维护**: 代码规范、注释完整，便于后续维护和扩展
5. **部署便捷**: 支持Docker容器化部署，提供完整的部署脚本

### 扩展性
系统设计充分考虑了扩展性，支持：
- 功能模块的灵活扩展
- 微服务架构的平滑迁移
- 多数据库支持
- 分布式部署

### 生产就绪
系统已具备生产环境部署的所有要素：
- 完整的监控和日志系统
- 自动化部署脚本
- 健康检查和故障恢复
- 性能优化和安全加固

该系统可以作为高校信息化建设的重要组成部分，为师生提供高效、便捷的公告发布和管理服务。
